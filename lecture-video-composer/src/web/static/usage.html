<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½¿ç”¨ç»Ÿè®¡ - æ¼”è®²è§†é¢‘åˆæˆç³»ç»Ÿ</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .usage-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .stat-limit {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: #FF9800;
        }

        .progress-fill.danger {
            background: #F44336;
        }

        .history-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .history-section h2 {
            margin: 0 0 20px 0;
            color: #333;
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-description {
            color: #333;
        }

        .history-time {
            color: #999;
            font-size: 14px;
        }

        .action-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 10px;
        }

        .action-upload {
            background: #E3F2FD;
            color: #1976D2;
        }

        .action-create {
            background: #F3E5F5;
            color: #7B1FA2;
        }

        .action-export {
            background: #E8F5E9;
            color: #388E3C;
        }

        .btn-reset {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn-reset:hover {
            background: #d32f2f;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .percentage-text {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="usage-container">
        <header style="text-align: center; margin-bottom: 30px;">
            <h1>ğŸ“Š ä½¿ç”¨ç»Ÿè®¡</h1>
            <p style="color: #666;">æŸ¥çœ‹æ‚¨çš„ä½¿ç”¨æƒ…å†µå’Œé…é¢</p>
        </header>

        <div class="stats-grid" id="statsGrid">
            <!-- ç»Ÿè®¡å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="history-section">
            <h2>ä½¿ç”¨å†å²</h2>
            <ul class="history-list" id="historyList">
                <!-- å†å²è®°å½•å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>

        <div style="text-align: center;">
            <button class="btn-reset" onclick="resetUsage()">é‡ç½®ç»Ÿè®¡æ•°æ®</button>
            <a href="app.html" style="margin-left: 20px; color: #4CAF50;">è¿”å›ä¸»é¡µ</a>
        </div>
    </div>

    <script>
        // åŠ è½½ä½¿ç”¨ç»Ÿè®¡
        async function loadUsageStats() {
            try {
                const response = await fetch('/api/usage/stats');
                const data = await response.json();

                if (!data.success) {
                    if (response.status === 401) {
                        // åˆ›å»ºä¼šè¯
                        await fetch('/api/session/create', { method: 'POST' });
                        // é‡æ–°åŠ è½½
                        return loadUsageStats();
                    }
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }

                renderStats(data.stats);
                renderHistory(data.stats.history);
            } catch (error) {
                console.error('åŠ è½½ä½¿ç”¨ç»Ÿè®¡å¤±è´¥:', error);
                alert('åŠ è½½ä½¿ç”¨ç»Ÿè®¡å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
        function renderStats(stats) {
            const grid = document.getElementById('statsGrid');
            grid.innerHTML = '';

            // é¡¹ç›®ç»Ÿè®¡
            grid.appendChild(createStatCard(
                'åˆ›å»ºçš„é¡¹ç›®',
                stats.projects.used,
                stats.projects.limit,
                stats.projects.percentage,
                'é¡¹ç›®'
            ));

            // å¯¼å‡ºç»Ÿè®¡
            grid.appendChild(createStatCard(
                'å¯¼å‡ºçš„è§†é¢‘',
                stats.exports.used,
                stats.exports.limit,
                stats.exports.percentage,
                'ä¸ª'
            ));

            // æ—¶é•¿ç»Ÿè®¡
            grid.appendChild(createStatCard(
                'å¯¼å‡ºæ—¶é•¿',
                stats.duration.formatted,
                formatDuration(stats.duration.limit),
                stats.duration.percentage,
                ''
            ));

            // å­˜å‚¨ç»Ÿè®¡
            grid.appendChild(createStatCard(
                'ä½¿ç”¨çš„å­˜å‚¨',
                stats.storage.formatted,
                formatSize(stats.storage.limit),
                stats.storage.percentage,
                ''
            ));
        }

        // åˆ›å»ºç»Ÿè®¡å¡ç‰‡
        function createStatCard(title, used, limit, percentage, unit) {
            const card = document.createElement('div');
            card.className = 'stat-card';

            const progressClass = percentage > 80 ? 'danger' : percentage > 60 ? 'warning' : '';

            // å¤„ç†å·²æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ "1.5 MB"ï¼‰å’Œéœ€è¦æ·»åŠ å•ä½çš„æ•°å­—
            const usedDisplay = typeof used === 'string' && used.includes(' ') ? used : `${used}${unit}`;
            const limitDisplay = typeof limit === 'string' && limit.includes(' ') ? limit : `${limit}${unit}`;

            card.innerHTML = `
                <h3>${title}</h3>
                <div class="stat-value">${usedDisplay}</div>
                <div class="stat-limit">é™åˆ¶: ${limitDisplay}</div>
                <div class="progress-bar">
                    <div class="progress-fill ${progressClass}" style="width: ${percentage}%"></div>
                </div>
                <div class="percentage-text">${percentage}% å·²ä½¿ç”¨</div>
            `;

            return card;
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory(history) {
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            if (!history || history.length === 0) {
                list.innerHTML = '<li class="empty-state">æš‚æ— ä½¿ç”¨è®°å½•</li>';
                return;
            }

            history.reverse().forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';

                const actionClass = {
                    'upload': 'action-upload',
                    'create_project': 'action-create',
                    'export': 'action-export'
                }[item.action] || 'action-upload';

                const actionText = {
                    'upload': 'ä¸Šä¼ ',
                    'create_project': 'åˆ›å»º',
                    'export': 'å¯¼å‡º'
                }[item.action] || item.action;

                li.innerHTML = `
                    <div>
                        <span class="action-badge ${actionClass}">${actionText}</span>
                        <span class="history-description">${item.description}</span>
                    </div>
                    <span class="history-time">${formatTime(item.timestamp)}</span>
                `;

                list.appendChild(li);
            });
        }

        // é‡ç½®ç»Ÿè®¡
        async function resetUsage() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ä½¿ç”¨ç»Ÿè®¡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch('/api/usage/reset', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('ç»Ÿè®¡å·²é‡ç½®');
                    loadUsageStats();
                } else {
                    throw new Error(data.error || 'é‡ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('é‡ç½®å¤±è´¥:', error);
                alert('é‡ç½®å¤±è´¥: ' + error.message);
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            // å°äº1åˆ†é’Ÿ
            if (diff < 60000) {
                return 'åˆšåˆš';
            }
            // å°äº1å°æ—¶
            if (diff < 3600000) {
                return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            }
            // å°äº1å¤©
            if (diff < 86400000) {
                return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            }
            // æ˜¾ç¤ºæ—¥æœŸ
            return date.toLocaleDateString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            }
            return `${minutes}åˆ†é’Ÿ`;
        }

        // æ ¼å¼åŒ–å¤§å°
        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return `${size.toFixed(1)} ${units[unitIndex]}`;
        }

        // é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡
        window.addEventListener('load', loadUsageStats);
    </script>
</body>
</html>
