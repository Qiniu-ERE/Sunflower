# 视频导出模块文档

> **版本**: v1.1  
> **日期**: 2025-10-24  
> **状态**: 已完成 ✅  
> **功能**: 将音频+照片序列合成为标准视频文件

---

## 一、功能概述

视频导出模块 (Video Exporter) 是演讲视频合成系统的核心功能之一，负责将音频文件和照片序列合成为标准的 MP4 视频文件。

### 主要特性

✅ **FFmpeg 集成** - 使用业界标准的 FFmpeg 进行视频编码  
✅ **灵活配置** - 支持自定义分辨率、帧率、比特率等参数  
✅ **高质量输出** - 使用 H.264 编码，兼容性好  
✅ **自动缩放** - 照片自动缩放并填充到目标分辨率  
✅ **进度跟踪** - 详细的日志输出，实时跟踪处理进度  
✅ **临时文件管理** - 自动清理临时文件，避免磁盘空间浪费

---

## 二、模块结构

### 文件位置

```
lecture-video-composer/
└── src/
    └── services/
        └── video/
            └── video_exporter.py  # 视频导出服务
```

### 核心类

#### 1. VideoExportConfig

视频导出配置类，使用 `@dataclass` 装饰器定义。

```python
@dataclass
class VideoExportConfig:
    resolution: str = "1920x1080"  # 视频分辨率
    fps: int = 30                  # 帧率
    video_codec: str = "libx264"   # 视频编码器
    audio_codec: str = "aac"       # 音频编码器
    video_bitrate: str = "5000k"   # 视频比特率
    audio_bitrate: str = "192k"    # 音频比特率
    pixel_format: str = "yuv420p"  # 像素格式
    preset: str = "medium"         # 编码速度预设
    crf: int = 23                  # 恒定质量因子
```

#### 2. VideoExporter

视频导出器类，负责执行视频合成操作。

**主要方法**:
- `export_video()` - 导出视频文件
- `get_video_info()` - 获取视频文件信息
- `_create_photo_segments()` - 创建照片视频片段
- `_concatenate_segments()` - 合并视频片段
- `_add_audio_track()` - 添加音频轨道

---

## 三、配置参数详解

### 3.1 分辨率 (resolution)

视频输出分辨率，格式为 "宽x高"。

**常用分辨率**:
- `"1920x1080"` - Full HD (1080p) **【默认】**
- `"1280x720"` - HD (720p)
- `"3840x2160"` - 4K (2160p)
- `"2560x1440"` - 2K (1440p)

**注意**: 照片会自动缩放并居中填充到目标分辨率，保持原始宽高比。

### 3.2 帧率 (fps)

视频帧率，单位为帧/秒 (frames per second)。

**推荐值**:
- `24` - 电影标准帧率
- `30` - 标准视频帧率 **【默认】**
- `60` - 高帧率，流畅度更好

**说明**: 由于照片是静态的，使用较低的帧率（24-30）即可满足需求，同时减小文件大小。

### 3.3 视频编码器 (video_codec)

视频编码格式。

**推荐值**:
- `"libx264"` - H.264 编码器 **【默认】** - 兼容性最好
- `"libx265"` - H.265/HEVC 编码器 - 压缩率更高，但兼容性较差

### 3.4 音频编码器 (audio_codec)

音频编码格式。

**推荐值**:
- `"aac"` - AAC 编码器 **【默认】** - 兼容性好，质量高
- `"mp3"` - MP3 编码器 - 传统格式，兼容性极好

### 3.5 视频比特率 (video_bitrate)

视频比特率，直接影响视频质量和文件大小。

**推荐值**:
- `"2500k"` - 720p 低质量
- `"5000k"` - 1080p 标准质量 **【默认】**
- `"8000k"` - 1080p 高质量
- `"20000k"` - 4K 标准质量

### 3.6 音频比特率 (audio_bitrate)

音频比特率。

**推荐值**:
- `"128k"` - 中等质量
- `"192k"` - 高质量 **【默认】**
- `"320k"` - 超高质量

### 3.7 编码预设 (preset)

编码速度与质量的平衡。

**可选值** (从快到慢):
- `"ultrafast"` - 最快，质量较低
- `"fast"` - 快速，质量中等
- `"medium"` - 中速，质量较好 **【默认】**
- `"slow"` - 慢速，质量优秀
- `"veryslow"` - 很慢，质量最佳

**说明**: 更慢的预设会提高压缩效率和质量，但编码时间更长。

### 3.8 质量因子 (crf)

恒定质量因子 (Constant Rate Factor)，范围 0-51。

**推荐值**:
- `18` - 视觉无损质量
- `23` - 默认值，质量较好 **【默认】**
- `28` - 质量一般

**说明**: 值越小质量越好，文件越大。推荐使用 18-28 之间的值。

---

## 四、使用方法

### 4.1 基础使用

```python
from pathlib import Path
from core.lecture_composer import LectureComposer

# 创建合成器
composer = LectureComposer(
    audio_file=Path("audio.mp3"),
    photo_files=[Path("photo1.jpg"), Path("photo2.jpg")],
    output_dir=Path("output")
)

# 处理项目
composer.process(title="我的演讲", save=True)

# 导出视频（使用默认配置）
video_file = composer.export_video()
print(f"视频已导出: {video_file}")
```

### 4.2 自定义配置

```python
from services.video.video_exporter import VideoExportConfig

# 创建自定义配置
config = VideoExportConfig(
    resolution="1280x720",    # 720p
    fps=24,                   # 24fps
    video_bitrate="3000k",    # 3Mbps
    preset="fast",            # 快速编码
    crf=20                    # 高质量
)

# 导出视频
video_file = composer.export_video(
    output_file=Path("output/my_video.mp4"),
    config=config
)
```

### 4.3 命令行使用

```bash
cd lecture-video-composer

# 基本使用（包含视频导出）
python src/core/lecture_composer.py \
    examples/fixtures/2025-10-24-15:15:15.mp3 \
    examples/fixtures/sample-photos/ \
    --export-video

# 自定义配置
python src/core/lecture_composer.py \
    examples/fixtures/2025-10-24-15:15:15.mp3 \
    examples/fixtures/sample-photos/ \
    --export-video \
    --video-file output/my_video.mp4 \
    --resolution 1280x720 \
    --fps 24 \
    --bitrate 3000k
```

### 4.4 运行测试脚本

```bash
# 运行视频导出功能测试
python examples/basic/test_video_export.py
```

测试脚本包含:
1. FFmpeg 安装检查
2. 配置测试（默认、自定义、高质量）
3. 完整导出流程测试
4. 视频信息提取测试

---

## 五、工作流程

### 5.1 整体流程

```
输入：音频文件 + 照片列表 + 时间轴信息
  ↓
Step 1: 为每张照片创建视频片段
  - 将静态图片转换为指定时长的视频
  - 自动缩放并填充到目标分辨率
  ↓
Step 2: 合并视频片段
  - 使用 FFmpeg concat demuxer 无缝合并
  ↓
Step 3: 添加音频轨道
  - 将音频文件合并到视频
  ↓
输出：完整的 MP4 视频文件
```

### 5.2 FFmpeg 命令详解

#### Step 1: 创建照片视频片段

```bash
ffmpeg -y \
  -loop 1 \                              # 循环输入图片
  -i photo.jpg \                         # 输入照片
  -t 60 \                                # 持续时间（秒）
  -vf "scale=1920x1080:force_original_aspect_ratio=decrease,pad=1920x1080:(ow-iw)/2:(oh-ih)/2,setsar=1" \
  -r 30 \                                # 帧率
  -c:v libx264 \                         # 视频编码器
  -preset medium \                       # 编码预设
  -crf 23 \                              # 质量因子
  -pix_fmt yuv420p \                     # 像素格式
  segment.mp4                            # 输出文件
```

**视频滤镜说明**:
- `scale=1920x1080:force_original_aspect_ratio=decrease` - 缩小到目标尺寸内
- `pad=1920x1080:(ow-iw)/2:(oh-ih)/2` - 居中填充到目标尺寸
- `setsar=1` - 设置像素宽高比为 1:1

#### Step 2: 合并视频片段

```bash
# 创建合并列表文件 (concat_list.txt)
file '/path/to/segment_0000.mp4'
file '/path/to/segment_0001.mp4'
file '/path/to/segment_0002.mp4'

# 执行合并
ffmpeg -y \
  -f concat \                            # concat demuxer
  -safe 0 \                              # 允许绝对路径
  -i concat_list.txt \                   # 输入列表文件
  -c copy \                              # 直接复制流（不重新编码）
  video_only.mp4                         # 输出文件
```

#### Step 3: 添加音频轨道

```bash
ffmpeg -y \
  -i video_only.mp4 \                    # 输入视频
  -i audio.mp3 \                         # 输入音频
  -c:v copy \                            # 复制视频流
  -c:a aac \                             # 音频编码器
  -b:a 192k \                            # 音频比特率
  -shortest \                            # 以较短的流为准
  final_video.mp4                        # 输出文件
```

---

## 六、输出示例

### 6.1 项目目录结构

```
output/
├── metadata.json              # 项目元数据
├── video.mp4                  # 导出的视频文件 ✨
├── video_720p.mp4            # 可选：不同配置的视频
├── audio/
│   └── 2025-10-24-15:15:15.mp3
└── photos/
    ├── 2025-10-24-15:15:15.jpg
    ├── 2025-10-24-15:15:55.jpg
    └── ...
```

### 6.2 视频信息示例

使用 `get_video_info()` 方法获取:

```json
{
  "duration": 600.0,
  "size": 75000000,
  "bitrate": 1000000,
  "video": {
    "codec": "h264",
    "width": 1920,
    "height": 1080,
    "fps": 30.0
  },
  "audio": {
    "codec": "aac",
    "sample_rate": 44100,
    "channels": 2
  }
}
```

---

## 七、性能优化

### 7.1 编码速度优化

**快速编码**（测试/预览）:
```python
config = VideoExportConfig(
    preset="ultrafast",  # 最快编码
    crf=28              # 较低质量
)
```

**高质量编码**（最终输出）:
```python
config = VideoExportConfig(
    preset="slow",      # 慢速编码
    crf=18              # 高质量
)
```

### 7.2 文件大小优化

**减小文件大小**:
```python
config = VideoExportConfig(
    resolution="1280x720",    # 降低分辨率
    video_bitrate="2500k",    # 降低比特率
    crf=28                    # 提高压缩率
)
```

### 7.3 编码时间估算

以 10 分钟音频 + 10 张照片为例：

| 预设 | 编码时间 | 文件大小 (1080p) |
|------|---------|------------------|
| ultrafast | ~30秒 | ~120MB |
| fast | ~1分钟 | ~90MB |
| medium | ~2分钟 | ~75MB |
| slow | ~5分钟 | ~60MB |
| veryslow | ~10分钟 | ~55MB |

**注意**: 实际时间取决于 CPU 性能和照片数量。

---

##
