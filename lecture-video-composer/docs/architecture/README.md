# 技术架构文档

## 📐 系统架构概述

演讲视频合成系统采用分层架构设计，将系统划分为四个主要层次，确保代码的可维护性和可扩展性。

## 🏗️ 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                   用户界面层 (UI Layer)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  播放控制界面  │  │  时间轴编辑器  │  │  文件管理界面  │      │
│  │  PlayControl  │  │  Timeline UI  │  │  FileManager  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                业务逻辑层 (Business Layer)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  播放管理器   │  │  时间同步引擎  │  │  导出管理器   │      │
│  │  PlayManager │  │  TimelineSync │  │ ExportManager│      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                数据服务层 (Data Layer)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  音频解析器   │  │  图片加载器   │  │  元数据服务   │      │
│  │ AudioParser  │  │ ImageLoader  │  │MetadataService│      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              基础设施层 (Infrastructure)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  文件系统     │  │  媒体编解码   │  │  渲染引擎     │      │
│  │ FileSystem   │  │ MediaCodec   │  │RenderEngine  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 核心模块说明

### 1. 用户界面层 (UI Layer)

#### 1.1 播放控制界面 (PlayControl)
**职责**：提供播放、暂停、进度控制等交互功能

**主要组件**：
- 播放/暂停按钮
- 进度条拖动
- 音量控制
- 倍速选择

#### 1.2 时间轴编辑器 (Timeline UI)
**职责**：可视化显示时间轴，标记照片位置

**主要功能**：
- 显示音频波形
- 标记照片时间点
- 支持拖动调整
- 缩放时间轴

#### 1.3 文件管理界面 (FileManager)
**职责**：管理音频和照片文件的导入

**主要功能**：
- 拖拽上传
- 文件列表显示
- 文件预览
- 批量导入

### 2. 业务逻辑层 (Business Layer)

#### 2.1 播放管理器 (PlayManager)
**职责**：协调音频播放和照片切换

**核心方法**：
```javascript
class PlayManager {
  play()           // 开始播放
  pause()          // 暂停播放
  seek(time)       // 跳转到指定时间
  setVolume(vol)   // 设置音量
  setSpeed(speed)  // 设置播放速度
}
```

#### 2.2 时间同步引擎 (TimelineSync)
**职责**：建立音频和照片的时间轴映射关系

**核心算法**：
- 解析文件名时间戳
- 计算相对偏移量
- 构建时间轴数据结构
- 实时查询当前应显示的照片

**数据结构**：
```javascript
{
  audioStartTime: Date,
  audioDuration: Number,
  photos: [
    {
      offset: Number,      // 相对音频开始的秒数
      file: File,
      duration: Number     // 显示持续时间
    }
  ]
}
```

#### 2.3 导出管理器 (ExportManager)
**职责**：将音频和照片合成为视频文件

**工作流程**：
1. 生成视频帧序列
2. 调用FFmpeg合成
3. 进度反馈
4. 完成回调

### 3. 数据服务层 (Data Layer)

#### 3.1 音频解析器 (AudioParser)
**职责**：解析音频文件元数据

**功能**：
- 提取音频时长
- 获取采样率
- 解析编码格式
- 生成波形数据

#### 3.2 图片加载器 (ImageLoader)
**职责**：高效加载和缓存图片

**优化策略**：
- 预加载下一张照片
- 图片压缩和缩略图
- LRU缓存机制
- 懒加载

#### 3.3 元数据服务 (MetadataService)
**职责**：管理项目元数据

**数据模型**：
```json
{
  "version": "1.0",
  "title": "演讲标题",
  "audio": {...},
  "timeline": [...],
  "settings": {...}
}
```

### 4. 基础设施层 (Infrastructure)

#### 4.1 文件系统 (FileSystem)
- File API 访问本地文件
- IndexedDB 存储项目数据
- Blob/ArrayBuffer 处理二进制数据

#### 4.2 媒体编解码 (MediaCodec)
- Web Audio API 音频处理
- Canvas API 图像处理
- FFmpeg.wasm 视频编码

#### 4.3 渲染引擎 (RenderEngine)
- 照片渲染和过渡效果
- 时间轴可视化
- 性能优化（requestAnimationFrame）

## 🔄 数据流

### 文件导入流程
```
用户拖拽文件 
  → FileManager接收
  → AudioParser/ImageLoader解析
  → TimelineSync构建时间轴
  → MetadataService保存元数据
  → UI更新显示
```

### 播放流程
```
用户点击播放
  → PlayManager.play()
  → 音频开始播放
  → 定时器监听播放进度
  → TimelineSync查询当前照片
  → RenderEngine渲染照片
  → UI更新进度条
```

### 导出流程
```
用户点击导出
  → ExportManager.export()
  → 生成帧序列
  → FFmpeg合成视频
  → 下载视频文件
  → 完成通知
```

## 🎯 技术选型

### 前端框架
- **MVP阶段**: 原生JavaScript + HTML5
- **后续**: React/Vue（根据团队技术栈）

### 音频处理
- **Web Audio API**: 音频播放和控制
- **wavesurfer.js**: 波形可视化（可选）

### 图像处理
- **Canvas API**: 图片渲染和过渡效果
- **PixiJS**: 高性能2D渲染（后期优化）

### 视频编码
- **FFmpeg.wasm**: 浏览器端视频合成
- **后端方案**: Node.js + FFmpeg（性能更好）

### 状态管理
- **MVP阶段**: 原生事件系统
- **后续**: Redux/Vuex（复杂状态管理）

### 存储方案
- **IndexedDB**: 项目数据本地存储
- **LocalStorage**: 用户设置
- **云存储**: AWS S3/七牛云（后期）

## 🔐 安全考虑

### 文件安全
- 文件类型验证（白名单）
- 文件大小限制
- 沙箱执行环境

### 数据隐私
- 本地优先处理
- 可选的云端同步
- 数据加密存储

## 📈 性能优化

### 加载优化
- 照片预加载
- 懒加载策略
- 资源压缩

### 渲染优化
- 虚拟列表（大量照片）
- requestAnimationFrame
- Web Worker 异步处理

### 内存优化
- 图片缓存限制
- 及时释放资源
- 内存泄漏监控

## 🔍 可扩展性设计

### 插件系统
- 支持自定义过渡效果
- 支持第三方滤镜
- 支持导出格式扩展

### API设计
- RESTful API（后端服务）
- 事件驱动架构
- 模块化设计

## 📊 监控和日志

### 性能监控
- 播放流畅度指标
- 照片切换延迟
- 内存使用情况

### 错误日志
- 异常捕获和上报
- 用户行为追踪
- 崩溃分析

## 🔄 版本演进

### v1.0 (MVP)
- 基础播放功能
- 简单UI界面
- 纯前端实现

### v2.0 (增强版)
- 视频导出功能
- 时间轴编辑
- 性能优化

### v3.0 (智能版)
- AI字幕生成
- 智能关键帧
- 云端同步

---

**更新日期**: 2025-10-24  
**维护者**: Sunflower Team
