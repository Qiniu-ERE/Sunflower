# 字幕问题排查指南

## 问题排查步骤

### 1. 查看运行日志

运行程序时，注意查看以下日志信息：

```bash
# 运行程序
python src/core/lecture_composer.py \
    examples/fixtures/2025-10-24-15:15:15.mp3 \
    examples/fixtures/sample-photos/ \
    --export-video

# 查看日志中的字幕相关信息
```

关键日志信息：
```
INFO:services.video.video_exporter:Step 3: Generating subtitles...
INFO:services.subtitle.subtitle_service:Whisper is available
INFO:services.subtitle.subtitle_service:Loading Whisper model: base
INFO:services.subtitle.subtitle_service:Transcribing audio...
INFO:services.subtitle.subtitle_service:Generated XX subtitle segments
INFO:services.subtitle.subtitle_service:Subtitles saved to: ...
```

### 2. 检查字幕文件是否生成

查看临时目录中的字幕文件：

```bash
# 检查输出目录
ls -la lecture-video-composer/output/.temp_video/

# 应该看到：
# - *.srt (SRT字幕文件)
# - *.ass (ASS字幕文件)
```

如果没有看到字幕文件，继续下一步排查。

### 3. 检查Whisper是否可用

```bash
# 测试Whisper导入
python -c "import whisper; print('Whisper is available')"

# 如果报错：ModuleNotFoundError
pip install openai-whisper
```

### 4. 检查Whisper模型是否下载

```bash
# 检查模型缓存目录
ls -lh ~/.cache/whisper/

# 应该看到：
# - base.pt (约142MB)
# - 或其他模型文件
```

如果没有模型文件，参考 [SSL问题解决方案](../bugfix/SSL问题解决方案.md) 手动下载。

### 5. 测试字幕生成功能

创建测试脚本 `test_subtitle.py`：

```python
from pathlib import Path
import sys

# 添加项目路径
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root / 'src'))

from services.subtitle.subtitle_service import SubtitleService, SubtitleConfig

# 测试字幕生成
audio_file = Path('examples/fixtures/2025-10-24-15:15:15.mp3')
output_dir = Path('output/test_subtitles')
output_dir.mkdir(parents=True, exist_ok=True)

print(f"Testing subtitle generation for: {audio_file}")
print(f"Output directory: {output_dir}")

try:
    # 创建字幕服务
    config = SubtitleConfig(model='base', language='zh')
    service = SubtitleService(config)
    
    # 生成字幕
    subtitle_file = service.generate_subtitles(audio_file, output_dir)
    
    if subtitle_file:
        print(f"✅ Success! Subtitle file: {subtitle_file}")
        print(f"   File size: {subtitle_file.stat().st_size} bytes")
        
        # 显示前几行
        print("\nFirst few lines:")
        with open(subtitle_file, 'r', encoding='utf-8') as f:
            for i, line in enumerate(f):
                if i >= 10:
                    break
                print(line.rstrip())
    else:
        print("❌ Failed to generate subtitles")
        
except Exception as e:
    print(f"❌ Error: {e}")
    import traceback
    traceback.print_exc()
```

运行测试：
```bash
cd lecture-video-composer
python test_subtitle.py
```

---

## 常见问题和解决方案

### 问题1: ModuleNotFoundError: No module named 'whisper'

**原因**：未安装Whisper

**解决方案**：
```bash
pip install openai-whisper
```

### 问题2: SSL证书错误

**症状**：
```
URLError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED]>
```

**解决方案**：参考 [SSL问题解决方案](../bugfix/SSL问题解决方案.md)

**快速方案**：
```bash
# 方案1: 手动下载模型（推荐）
mkdir -p ~/.cache/whisper
cd ~/.cache/whisper

# 使用浏览器+VPN下载并保存为base.pt
# URL: https://openaipublic.azureedge.net/main/whisper/models/ed3a0b6b1c0edf879ad9b11b1af5a0e6ab5db9205f891f668f8b0e6c6326e34e/base.pt

# 方案2: 禁用字幕功能
python src/core/lecture_composer.py \
    audio.mp3 photos/ \
    --export-video \
    --no-subtitles
```

### 问题3: FFmpeg字幕嵌入失败

**症状**：
```
Error applying option 'original_size' to filter 'subtitles'
```

**说明**：这是FFmpeg 8.0的已知bug，不影响视频生成

**当前处理**：
- ✅ 视频会正常生成（无字幕）
- ✅ 字幕文件会保存在临时目录
- ✅ 可以手动添加字幕

**手动添加字幕**：
```bash
# 找到字幕文件
find lecture-video-composer/output -name "*.srt"

# 使用FFmpeg手动添加字幕
ffmpeg -i output/video.mp4 \
    -vf "subtitles=path/to/subtitle.srt" \
    -c:v libx264 -crf 23 \
    output/video_with_subtitles.mp4
```

### 问题4: 字幕文件为空

**原因**：音频转录失败或没有识别到语音

**排查**：
```bash
# 检查音频文件是否正常
ffprobe examples/fixtures/2025-10-24-15:15:15.mp3

# 尝试用更小的模型
python src/core/lecture_composer.py \
    audio.mp3 photos/ \
    --export-video \
    --subtitle-model tiny  # 使用tiny模型
```

### 问题5: 内存不足

**症状**：
```
RuntimeError: CUDA out of memory
或
MemoryError
```

**解决方案**：
```bash
# 使用更小的模型
# tiny: ~75MB内存
# base: ~142MB内存（默认）
# small: ~466MB内存

# 在代码中修改模型大小
# 编辑 src/services/video/video_exporter.py
# 找到 SubtitleConfig(model="base", ...)
# 改为 SubtitleConfig(model="tiny", ...)
```

---

## 检查清单

运行以下命令检查所有依赖：

```bash
# 1. 检查Python版本
python --version
# 需要: Python 3.8+

# 2. 检查FFmpeg
ffmpeg -version
# 需要: FFmpeg 4.0+

# 3. 检查Whisper
python -c "import whisper; print('OK')"
# 应输出: OK

# 4. 检查Whisper模型
ls -lh ~/.cache/whisper/
# 应看到: base.pt (约142MB)

# 5. 检查磁盘空间
df -h
# 需要: 至少2GB可用空间

# 6. 运行测试
cd lecture-video-composer
python test_subtitle.py
# 应生成字幕文件
```

---

## 推荐配置

### 最小配置（快速测试）
```bash
# 不使用字幕，最快
python src/core/lecture_composer.py \
    audio.mp3 photos/ \
    --export-video \
    --no-subtitles
```

### 标准配置（推荐）
```bash
# 720p + 字幕（需要Whisper模型）
python src/core/lecture_composer.py \
    audio.mp3 photos/ \
    --export-video
```

### 高质量配置
```bash
# 1080p + 高质量字幕
python src/core/lecture_composer.py \
    audio.mp3 photos/ \
    --export-video \
    --resolution 1920x1080 \
    --bitrate 5000k
```

---

## 获取帮助

如果以上方法都无法解决问题：

1. **收集信息**：
   ```bash
   # 运行诊断命令
   python src/core/lecture_composer.py \
       audio.mp3 photos/ \
       --export-video \
       2>&1 | tee debug.log
   ```

2. **查看完整日志**：
   ```bash
   cat debug.log
   ```

3. **检查临时文件**：
   ```bash
   ls -la output/.temp_video/
   ```

4. **提交Issue**：
   - 附上 debug.log
   - 说明系统信息（macOS/Linux/Windows）
   - FFmpeg版本
   - Python版本

---

## 总结

**字幕功能是可选的增强功能**，如果遇到问题：

1. ✅ **最简单方案**：使用 `--no-subtitles` 跳过字幕
2. ✅ **标准方案**：手动下载Whisper模型后使用字幕
3. ✅ **备用方案**：先生成视频，后期手动添加字幕

**核心功能不受影响**：
- ✅ 720p视频导出
- ✅ 音频同步
- ✅ 照片切换
- ✅ 时间轴管理

所有这些功能都正常工作，不依赖字幕功能！
