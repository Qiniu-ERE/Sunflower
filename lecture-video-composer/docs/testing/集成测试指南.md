# é›†æˆæµ‹è¯•æŒ‡å—

> ç«¯åˆ°ç«¯æµ‹è¯•æµç¨‹ï¼ŒéªŒè¯ç³»ç»Ÿå„æ¨¡å—é—´çš„åä½œ

---

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

é›†æˆæµ‹è¯•éªŒè¯ç³»ç»Ÿå„ç»„ä»¶ä¹‹é—´çš„äº¤äº’ï¼Œç¡®ä¿å®Œæ•´çš„ç”¨æˆ·æµç¨‹æ­£å¸¸å·¥ä½œã€‚

### æµ‹è¯•èŒƒå›´

- âœ… Web API é›†æˆæµ‹è¯•
- âœ… å‰åç«¯äº¤äº’æµ‹è¯•
- âœ… æ–‡ä»¶ä¸Šä¼ æµç¨‹æµ‹è¯•
- âœ… æ’­æ”¾å™¨åŠŸèƒ½æµ‹è¯•
- âœ… ä¼šè¯ç®¡ç†æµ‹è¯•

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡

```bash
# 1. ç¡®ä¿æ‰€æœ‰ä¾èµ–å·²å®‰è£…
cd lecture-video-composer
pip install -r requirements.txt

# 2. å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
python run_web.py &

# 3. ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 3
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
pytest tests/web/ -v

# è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
pytest tests/web/test_file_api.py -v
pytest tests/web/test_playback_api.py -v
pytest tests/web/test_project_api.py -v
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### 1. æ–‡ä»¶ä¸Šä¼ æµç¨‹

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯æ–‡ä»¶ä¸Šä¼ çš„å®Œæ•´æµç¨‹

```python
def test_file_upload_workflow(client):
    """æµ‹è¯•æ–‡ä»¶ä¸Šä¼ å·¥ä½œæµ"""
    # 1. ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
    audio_response = upload_audio_file(client)
    assert audio_response.status_code == 200
    
    # 2. ä¸Šä¼ ç…§ç‰‡æ–‡ä»¶
    photo_response = upload_photo_files(client)
    assert photo_response.status_code == 200
    
    # 3. éªŒè¯æ–‡ä»¶åˆ—è¡¨
    files = get_uploaded_files(client)
    assert len(files['audio']) > 0
    assert len(files['photos']) > 0
```

**éªŒè¯ç‚¹**ï¼š
- âœ… æ–‡ä»¶æ­£ç¡®ä¸Šä¼ åˆ°æœåŠ¡å™¨
- âœ… æ–‡ä»¶åè§£ææ­£ç¡®ï¼ˆæ—¶é—´æˆ³æå–ï¼‰
- âœ… æ–‡ä»¶ç±»å‹éªŒè¯
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶

### 2. é¡¹ç›®åˆ›å»ºæµç¨‹

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯é¡¹ç›®åˆ›å»ºå’Œç®¡ç†

```python
def test_project_creation(client):
    """æµ‹è¯•é¡¹ç›®åˆ›å»ºæµç¨‹"""
    # 1. åˆ›å»ºæ–°é¡¹ç›®
    project_data = {
        'name': 'æµ‹è¯•é¡¹ç›®',
        'audio_file': 'test-audio.mp3',
        'photo_files': ['photo1.jpg', 'photo2.jpg']
    }
    
    response = client.post('/api/projects', json=project_data)
    assert response.status_code == 201
    
    project = response.json
    assert 'project_id' in project
    assert 'timeline' in project
```

**éªŒè¯ç‚¹**ï¼š
- âœ… é¡¹ç›®æˆåŠŸåˆ›å»º
- âœ… æ—¶é—´è½´æ­£ç¡®ç”Ÿæˆ
- âœ… æ–‡ä»¶å…³è”æ­£ç¡®
- âœ… å…ƒæ•°æ®æŒä¹…åŒ–

### 3. æ’­æ”¾å™¨åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯æ’­æ”¾æ§åˆ¶åŠŸèƒ½

```python
def test_playback_controls(client, project_id):
    """æµ‹è¯•æ’­æ”¾æ§åˆ¶"""
    # 1. åˆå§‹åŒ–æ’­æ”¾å™¨
    init_response = client.post(f'/api/playback/{project_id}/init')
    assert init_response.status_code == 200
    
    # 2. æ’­æ”¾
    play_response = client.post(f'/api/playback/{project_id}/play')
    assert play_response.status_code == 200
    
    # 3. æš‚åœ
    pause_response = client.post(f'/api/playback/{project_id}/pause')
    assert pause_response.status_code == 200
    
    # 4. è·³è½¬
    seek_response = client.post(
        f'/api/playback/{project_id}/seek',
        json={'time': 30.0}
    )
    assert seek_response.status_code == 200
```

**éªŒè¯ç‚¹**ï¼š
- âœ… æ’­æ”¾æ§åˆ¶æ­£å¸¸å“åº”
- âœ… çŠ¶æ€åŒæ­¥æ­£ç¡®
- âœ… æ—¶é—´è½´è·³è½¬å‡†ç¡®

### 4. ä¼šè¯ç®¡ç†æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯å¤šç”¨æˆ·ä¼šè¯éš”ç¦»

```python
def test_session_isolation(client):
    """æµ‹è¯•ä¼šè¯éš”ç¦»"""
    # åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹ä¼šè¯
    with client.session_transaction() as sess1:
        sess1['user_id'] = 'user1'
    
    with client.session_transaction() as sess2:
        sess2['user_id'] = 'user2'
    
    # éªŒè¯æ•°æ®éš”ç¦»
    files1 = get_user_files(client, 'user1')
    files2 = get_user_files(client, 'user2')
    
    assert files1 != files2
```

**éªŒè¯ç‚¹**ï¼š
- âœ… ä¼šè¯æ­£ç¡®åˆ›å»º
- âœ… ç”¨æˆ·æ•°æ®éš”ç¦»
- âœ… ä¼šè¯æŒä¹…åŒ–

---

## ğŸ“Š æµ‹è¯•è¦†ç›–

### å½“å‰è¦†ç›–ç‡

```
æ¨¡å—                    è¦†ç›–ç‡
-------------------------
src/web/api/           95%  âœ…
src/web/services/      90%  âœ…
src/core/player/       85%  âœ…
src/core/timeline/     88%  âœ…
src/services/          80%  ğŸš§
-------------------------
æ€»ä½“è¦†ç›–ç‡:            87%  âœ…
```

### API ç«¯ç‚¹æµ‹è¯•

| ç«¯ç‚¹ | æ–¹æ³• | æµ‹è¯•çŠ¶æ€ |
|------|------|----------|
| `/api/files/upload` | POST | âœ… å®Œæˆ |
| `/api/files/list` | GET | âœ… å®Œæˆ |
| `/api/projects` | GET/POST | âœ… å®Œæˆ |
| `/api/projects/<id>` | GET/DELETE | âœ… å®Œæˆ |
| `/api/playback/<id>/init` | POST | âœ… å®Œæˆ |
| `/api/playback/<id>/play` | POST | âœ… å®Œæˆ |
| `/api/playback/<id>/pause` | POST | âœ… å®Œæˆ |
| `/api/playback/<id>/seek` | POST | âœ… å®Œæˆ |
| `/api/playback/<id>/state` | GET | âœ… å®Œæˆ |

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. æµ‹è¯•æ•°æ®æ¸…ç†

**é—®é¢˜**ï¼šæµ‹è¯•åæ®‹ç•™æ•°æ®å½±å“ä¸‹æ¬¡æµ‹è¯•

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
@pytest.fixture(autouse=True)
def cleanup_test_data():
    """è‡ªåŠ¨æ¸…ç†æµ‹è¯•æ•°æ®"""
    yield
    # æ¸…ç†ä¸Šä¼ çš„æ–‡ä»¶
    clean_uploads_dir()
    # æ¸…ç†é¡¹ç›®æ•°æ®
    clean_projects_dir()
```

### 2. ç«¯å£å ç”¨

**é—®é¢˜**ï¼šæµ‹è¯•æœåŠ¡å™¨ç«¯å£è¢«å ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥æ‰¾å ç”¨è¿›ç¨‹
lsof -i :5000

# ç»ˆæ­¢è¿›ç¨‹
kill -9 <PID>
```

### 3. ä¼šè¯çŠ¶æ€

**é—®é¢˜**ï¼šæµ‹è¯•é—´ä¼šè¯çŠ¶æ€äº’ç›¸å¹²æ‰°

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
@pytest.fixture
def client(app):
    """ä¸ºæ¯ä¸ªæµ‹è¯•åˆ›å»ºç‹¬ç«‹å®¢æˆ·ç«¯"""
    with app.test_client() as client:
        with app.app_context():
            yield client
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æµ‹è¯•éš”ç¦»

- âœ… æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®
- âœ… æµ‹è¯•åæ¸…ç†èµ„æº
- âœ… é¿å…æµ‹è¯•é—´ä¾èµ–

### 2. æ–­è¨€æ¸…æ™°

```python
# âŒ ä¸å¥½çš„æ–­è¨€
assert response

# âœ… å¥½çš„æ–­è¨€
assert response.status_code == 200
assert 'project_id' in response.json
```

### 3. æµ‹è¯•å‘½å

```python
# æ¸…æ™°çš„æµ‹è¯•åç§°
def test_upload_audio_file_with_valid_format():
    """æµ‹è¯•ä¸Šä¼ æœ‰æ•ˆæ ¼å¼çš„éŸ³é¢‘æ–‡ä»¶"""
    pass

def test_upload_photo_file_with_timestamp_in_name():
    """æµ‹è¯•ä¸Šä¼ åŒ…å«æ—¶é—´æˆ³çš„ç…§ç‰‡æ–‡ä»¶"""
    pass
```

### 4. ä½¿ç”¨ Fixture

```python
@pytest.fixture
def sample_audio_file():
    """æä¾›æµ‹è¯•ç”¨éŸ³é¢‘æ–‡ä»¶"""
    return ('audio.mp3', io.BytesIO(b'audio content'), 'audio/mpeg')

@pytest.fixture
def sample_project(client):
    """åˆ›å»ºæµ‹è¯•é¡¹ç›®"""
    response = client.post('/api/projects', json={...})
    return response.json['project_id']
```

---

## ğŸ”„ æŒç»­é›†æˆ

### GitHub Actions é…ç½®

```yaml
name: Integration Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run integration tests
      run: |
        pytest tests/web/ -v --cov
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿæµ‹è¯•æŒ‡å—](./å¿«é€Ÿæµ‹è¯•æŒ‡å—.md) - åŸºç¡€åŠŸèƒ½æµ‹è¯•
- [å­—å¹•é—®é¢˜æ’æŸ¥æŒ‡å—](./å­—å¹•é—®é¢˜æ’æŸ¥æŒ‡å—.md) - å­—å¹•åŠŸèƒ½è°ƒè¯•
- [Web API æ–‡æ¡£](../api/Web_APIæ–‡æ¡£.md) - API æ¥å£å®šä¹‰

---

<p align="center">
  <sub>æœ€åæ›´æ–°ï¼š2025-10-26</sub>
</p>
