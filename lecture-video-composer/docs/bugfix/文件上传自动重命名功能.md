# 文件上传自动重命名功能

## 功能概述

为了降低用户操作难度，系统现在支持在文件上传时自动获取文件的创建时间戳，并将文件重命名为标准的时间戳格式 `YYYY-MM-DD HH:MM:SS`。

用户不再需要严格按照指定格式命名文件，系统会自动处理。

## 实现细节

### 1. 自动时间戳提取

系统在文件上传时会：
1. 先将文件临时保存到服务器
2. 读取文件的创建时间戳（使用系统的 `st_birthtime` 或 `st_ctime`）
3. 根据创建时间生成新的文件名
4. 将临时文件重命名为最终文件名

### 2. 文件命名格式

- **标准格式**: `YYYY-MM-DD HH:MM:SS.ext`
  - 例如: `2025-10-24 15:15:15.jpg`
  - 例如: `2025-10-24 15:15:15.mp3`

- **冲突处理**: 如果同名文件已存在，添加毫秒后缀
  - 例如: `2025-10-24 15:15:15.123.jpg`

### 3. 跨平台支持

- **macOS**: 使用 `st_birthtime` 获取真正的文件创建时间
- **Linux/Unix**: 使用 `st_ctime` 获取元数据修改时间（通常接近创建时间）
- **Windows**: 使用 `st_ctime` 获取创建时间

### 4. 错误处理

如果无法获取文件创建时间，系统会：
1. 记录警告日志
2. 使用当前服务器时间作为备选
3. 确保文件上传流程不会中断

## 代码实现

### 核心函数

```python
def get_file_creation_time(file: FileStorage, temp_path: Path) -> datetime:
    """
    获取文件的创建时间
    
    Args:
        file: 上传的文件对象
        temp_path: 临时保存的文件路径
        
    Returns:
        文件创建时间
    """
    try:
        stat_info = temp_path.stat()
        
        # macOS和某些系统支持st_birthtime（真正的创建时间）
        if hasattr(stat_info, 'st_birthtime'):
            timestamp = stat_info.st_birthtime
        else:
            # Linux等系统使用st_ctime（元数据修改时间）
            timestamp = stat_info.st_ctime
        
        return datetime.fromtimestamp(timestamp)
    except Exception as e:
        current_app.logger.warning(f"Failed to get file creation time: {e}")
        return datetime.now()


def save_uploaded_file(file: FileStorage, upload_dir: Path, prefix: str = '') -> Path:
    """
    保存上传的文件，自动根据文件创建时间重命名
    """
    # 1. 临时保存文件
    temp_filename = f"temp_{datetime.now().strftime('%Y%m%d_%H%M%S_%f')}{ext}"
    temp_filepath = upload_dir / temp_filename
    file.save(str(temp_filepath))
    
    try:
        # 2. 获取文件创建时间
        creation_time = get_file_creation_time(file, temp_filepath)
        
        # 3. 生成新文件名
        new_filename = creation_time.strftime('%Y-%m-%d %H:%M:%S') + ext
        
        # 4. 处理文件名冲突
        final_filepath = upload_dir / new_filename
        if final_filepath.exists():
            timestamp_with_ms = creation_time.strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]
            new_filename = timestamp_with_ms + ext
            final_filepath = upload_dir / new_filename
        
        # 5. 重命名为最终文件名
        temp_filepath.rename(final_filepath)
        
        return final_filepath
    except Exception as e:
        # 清理临时文件
        if temp_filepath.exists():
            temp_filepath.unlink()
        raise
```

## 使用示例

### 上传音频文件

```bash
# 用户上传任意命名的文件
curl -X POST http://localhost:5000/api/file/upload/audio \
  -F "file=@my_lecture.mp3" \
  -F "session_id=abc123"

# 服务器自动重命名为: 2025-10-24 15:15:15.mp3
```

### 上传照片文件

```bash
# 用户上传多个照片，无需关心文件名
curl -X POST http://localhost:5000/api/file/upload/photos \
  -F "files=@IMG_001.jpg" \
  -F "files=@IMG_002.jpg" \
  -F "files=@IMG_003.jpg" \
  -F "session_id=abc123"

# 服务器根据每个文件的创建时间自动重命名
# 2025-10-24 15:15:15.jpg
# 2025-10-24 15:16:20.jpg
# 2025-10-24 15:17:30.jpg
```

## 优势

1. **降低用户操作难度**: 用户无需手动重命名文件
2. **保持时间准确性**: 使用文件的真实创建时间，而非上传时间
3. **避免命名错误**: 消除手动命名可能产生的格式错误
4. **自动冲突处理**: 智能处理同名文件，添加毫秒后缀
5. **跨平台兼容**: 支持不同操作系统的时间戳获取

## 注意事项

1. **文件创建时间的含义**:
   - 在某些系统上，文件复制或移动可能会改变创建时间
   - 建议用户直接从相机/录音设备上传原始文件

2. **时区处理**:
   - 系统使用服务器本地时区
   - 如需特定时区，可在配置中调整

3. **文件名中的冒号**:
   - 文件名包含冒号（`:`），在某些文件系统中可能受限
   - 系统已处理路径安全性，但下载到本地时某些系统可能自动转换

## 测试建议

1. 上传不同时间创建的文件，验证时间戳提取正确性
2. 上传同一时间创建的多个文件，验证冲突处理
3. 在不同操作系统上测试兼容性
4. 测试大文件上传的性能影响

## 相关文件

- `lecture-video-composer/src/web/api/file_api.py`: 文件上传API实现
- `lecture-video-composer/src/web/app.py`: Flask应用主文件

## 更新日期

2025-10-30
