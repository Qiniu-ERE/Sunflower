# 项目文件隔离问题修复

## 问题描述

### 症状
用户报告了一个严重的文件管理bug：

1. 上传音频和照片 → 保存为项目A
2. 删除所有音频和照片
3. 上传新的音频和照片 → 保存为项目B
4. 尝试播放或导出项目A时，提示找不到对应的文件

### 根本原因

系统在创建项目时，只在元数据中存储了**相对于上传目录的文件路径**，而没有将文件复制到项目自己的独立目录中。

**问题流程：**

```
1. 项目A创建时：
   - 文件上传到: /uploads/{session_id}/audio/file.mp3
   - 元数据保存: "audio_file": "audio/file.mp3" (相对路径)
   - 项目目录: /projects/{session_id}/{project_a_id}/metadata.json

2. 删除文件：
   - 用户删除: /uploads/{session_id}/audio/file.mp3
   - 用户删除: /uploads/{session_id}/photos/*.jpg

3. 项目B创建时：
   - 新文件上传到同一位置: /uploads/{session_id}/audio/new_file.mp3
   - 元数据保存新的路径引用

4. 加载项目A时：
   - 系统查找: /uploads/{session_id}/audio/file.mp3
   - 结果: 文件不存在！❌
```

### 影响范围

- ✅ 播放器无法加载项目A的音频和照片
- ✅ 视频导出无法找到项目A的源文件
- ✅ 多个项目之间的文件相互覆盖和删除

## 解决方案

### 核心思路

**实现项目文件隔离**：每个项目都在自己的目录中保存完整的文件副本，互不干扰。

### 新的文件结构

```
项目根目录/
├── data/
│   ├── uploads/                    # 临时上传区
│   │   └── {session_id}/
│   │       ├── audio/              # 临时音频文件
│   │       └── photos/             # 临时照片文件
│   │
│   └── projects/                   # 项目永久存储区
│       └── {session_id}/
│           └── {project_id}/       # 每个项目独立目录
│               ├── metadata.json   # 项目元数据
│               ├── audio/          # 项目专属音频
│               │   └── file.mp3
│               └── photos/         # 项目专属照片
│                   ├── photo1.jpg
│                   └── photo2.jpg
```

### 实现细节

#### 1. 项目创建时复制文件

**文件位置**: `lecture-video-composer/src/web/api/project_api.py`

```python
# 创建项目目录结构
project_dir = Path(current_app.config['PROJECTS_FOLDER']) / session_id / project_id
project_audio_dir = project_dir / 'audio'
project_photos_dir = project_dir / 'photos'
project_audio_dir.mkdir(parents=True, exist_ok=True)
project_photos_dir.mkdir(exist_ok=True)

# 复制音频文件到项目目录
project_audio_file = project_audio_dir / audio_file.name
shutil.copy2(audio_file, project_audio_file)

# 复制所有照片文件到项目目录
project_photo_files = []
for photo_file in photo_files:
    project_photo_file = project_photos_dir / photo_file.name
    shutil.copy2(photo_file, project_photo_file)
    project_photo_files.append(project_photo_file)

# 使用项目目录中的文件进行后续处理
audio_file = project_audio_file
photo_files = project_photo_files
```

#### 2. 元数据使用项目内相对路径

```python
# 保存相对于项目目录的路径
enhanced_metadata = {
    'project_id': project_id,
    'title': project_title,
    'created_at': datetime.now().isoformat(),
    'audio_file': f'audio/{audio_file.name}',  # 项目内相对路径
    'photo_files': [f'photos/{p.name}' for p in photo_files],
    'duration': composer.audio_metadata.duration,
    'timeline': timeline_items,
    'version': 'v2.2'
}
```

#### 3. 项目加载时使用项目目录

**文件位置**: `lecture-video-composer/src/web/api/project_api.py`

```python
# 使用项目目录而非上传目录
project_dir = metadata_path.parent

# 构建URL路径 - 指向项目目录
audio_path = f'/projects/{session_id}/{project_id}/{metadata["audio_file"]}'

# 照片URL也指向项目目录
for item in metadata.get('timeline', []):
    photo_filename = item['photo']
    timeline_item['photo'] = f'/projects/{session_id}/{project_id}/photos/{photo_filename}'
```

#### 4. 添加项目文件访问路由

**文件位置**: `lecture-video-composer/src/web/app.py`

```python
@app.route('/projects/<path:filepath>')
def serve_project(filepath):
    """提供项目文件访问"""
    try:
        projects_dir = Path(app.config['PROJECTS_FOLDER']).resolve()
        file_path = (projects_dir / filepath).resolve()
        
        # 安全检查：确保文件在项目目录内
        try:
            file_path.relative_to(projects_dir)
        except ValueError:
            return jsonify({'error': 'Invalid file path'}), 403
        
        if not file_path.exists():
            return jsonify({'error': 'File not found'}), 404
        
        return send_file(file_path)
    except Exception as e:
        return jsonify({'error': 'File access error'}), 500
```

#### 5. 视频导出使用项目文件

**文件位置**: `lecture-video-composer/src/web/api/export_api.py`

```python
# 从项目目录读取文件，而不是上传目录
project_dir = metadata_path.parent
audio_path = project_dir / metadata['audio_file']
photos_dir = project_dir / 'photos'
```

## 修改文件清单

1. ✅ `lecture-video-composer/src/web/api/project_api.py`
   - 添加文件复制逻辑
   - 修改元数据路径格式
   - 更新项目加载路径

2. ✅ `lecture-video-composer/src/web/app.py`
   - 添加 `/projects/<path:filepath>` 路由

3. ✅ `lecture-video-composer/src/web/api/export_api.py`
   - 修改视频导出使用项目目录

## 优势与效果

### ✅ 解决的问题

1. **文件隔离**：每个项目拥有独立的文件副本
2. **删除安全**：删除上传文件不会影响已创建的项目
3. **多项目支持**：可以创建多个项目而互不干扰
4. **版本控制**：项目文件独立存储，便于管理

### ✅ 使用体验改善

**修复前：**
```
1. 创建项目A ✓
2. 删除上传文件 ✓
3. 创建项目B ✓
4. 播放项目A ✗ (找不到文件)
```

**修复后：**
```
1. 创建项目A ✓ (文件已复制到项目A目录)
2. 删除上传文件 ✓ (只删除临时文件)
3. 创建项目B ✓ (文件复制到项目B目录)
4. 播放项目A ✓ (从项目A目录加载)
5. 播放项目B ✓ (从项目B目录加载)
6. 导出项目A ✓ (从项目A目录读取)
```

## 注意事项

### 存储空间

- 每个项目都会占用额外的存储空间（文件副本）
- 建议定期清理不需要的项目
- 可以考虑添加项目存储空间配额

### 性能影响

- 创建项目时需要复制文件，可能需要几秒钟
- 对于大文件（如长时间音频），复制时间会更长
- 建议在UI上显示"正在创建项目..."的进度提示

### 向后兼容性

**旧项目处理**：

如果系统中已有使用旧版本创建的项目（文件仍在uploads目录），需要考虑：

1. **选项A - 迁移**：编写迁移脚本将旧项目的文件复制到项目目录
2. **选项B - 兼容**：在加载时检测路径格式，自动适配新旧两种路径
3. **选项C - 提示**：提示用户重新创建项目

当前实现采用选项C，建议用户重新创建项目以获得最佳体验。

## 测试建议

### 手动测试步骤

1. **基本流程测试**
   ```
   1. 上传音频和照片
   2. 创建项目A
   3. 验证项目A可以正常播放
   4. 删除所有上传的文件
   5. 上传新的音频和照片
   6. 创建项目B
   7. 验证项目B可以正常播放
   8. 验证项目A仍然可以正常播放 ← 关键测试点
   9. 导出项目A的视频
   10. 导出项目B的视频
   ```

2. **文件系统验证**
   ```bash
   # 检查项目目录结构
   tree data/projects/
   
   # 验证每个项目都有独立的文件
   ls -la data/projects/{session_id}/{project_id}/audio/
   ls -la data/projects/{session_id}/{project_id}/photos/
   ```

3. **并发测试**
   - 同时创建多个项目
   - 验证文件不会相互覆盖

## 总结

这次修复从根本上解决了项目文件管理的架构问题，通过实现**文件隔离**确保每个项目的独立性和稳定性。这是一个重要的架构改进，为系统的可靠性和可扩展性奠定了基础。

### 关键改进

- 🎯 **文件隔离**：每个项目独立存储
- 🔒 **删除安全**：删除不影响已有项目
- 📦 **完整性**：项目包含所有必需文件
- 🚀 **可靠性**：项目长期可用

---

**修复日期**: 2025-10-26  
**版本**: v2.2.1  
**状态**: ✅ 已完成并测试
