# 计费统计模块文档

## 概述

计费统计模块提供了用户使用量的追踪和统计功能，可以记录和展示各类资源的使用情况，为未来的商业化提供数据基础。

## 功能特性

### 1. 使用量追踪

系统自动追踪以下使用指标：

- **会话管理**
  - 会话创建时间
  - 会话持续时长
  - 会话活跃状态

- **文件操作**
  - 文件上传数量
  - 文件总大小
  - 支持的文件类型

- **项目管理**
  - 项目创建数量
  - 项目文件数量
  - 项目时长统计

- **导出操作**
  - 视频导出次数
  - 导出总时长
  - 导出成功率

- **AI服务**
  - AI字幕生成次数
  - 语音识别时长
  - AI服务成功率

### 2. 统计API

#### 获取使用统计

```http
GET /api/usage/stats?session_id=<session_id>
```

**响应示例：**

```json
{
  "success": true,
  "stats": {
    "sessions": {
      "total": 1,
      "active": 1
    },
    "files": {
      "audio_count": 2,
      "image_count": 15,
      "total_size": 52428800,
      "total_size_mb": 50.0
    },
    "projects": {
      "total": 3,
      "total_duration": 1800
    },
    "exports": {
      "total": 5,
      "success": 4,
      "failed": 1,
      "total_duration": 900
    },
    "ai_services": {
      "subtitle_generation": 2,
      "total_audio_duration": 600
    }
  }
}
```

#### 记录使用事件

```http
POST /api/usage/record
Content-Type: application/json

{
  "session_id": "session-xxx",
  "event_type": "export",
  "metadata": {
    "duration": 300,
    "format": "mp4"
  }
}
```

### 3. 统计页面

系统提供了一个可视化的统计页面 `/usage.html`，展示：

- 会话统计卡片
- 文件统计卡片
- 项目统计卡片
- 导出统计卡片
- AI服务统计卡片

每个卡片显示相关指标和图标，支持实时刷新。

## 技术实现

### 后端实现

#### SessionManager 扩展

会话管理器 (`src/web/services/session_manager.py`) 负责追踪使用数据：

```python
class UserSession:
    def __init__(self, session_id: str):
        self.id = session_id
        self.created_at = datetime.now()
        self.last_access = datetime.now()
        self.projects: Dict[str, ProjectData] = {}
        self.current_project_id: Optional[str] = None
        
        # 使用统计
        self.usage = {
            'files': {
                'audio_count': 0,
                'image_count': 0,
                'total_size': 0
            },
            'exports': {
                'total': 0,
                'success': 0,
                'failed': 0,
                'total_duration': 0
            },
            'ai_services': {
                'subtitle_generation': 0,
                'total_audio_duration': 0
            }
        }
```

#### Usage API

使用统计API (`src/web/api/usage_api.py`) 提供了RESTful接口：

- `GET /api/usage/stats`: 获取使用统计
- `POST /api/usage/record`: 记录使用事件

### 前端实现

统计页面 (`src/web/static/usage.html`) 使用原生JavaScript实现：

```javascript
async function loadUsageStats() {
    const sessionId = localStorage.getItem('sessionId');
    const response = await fetch(`/api/usage/stats?session_id=${sessionId}`);
    const data = await response.json();
    updateStatsDisplay(data.stats);
}
```

## 集成方式

### 1. 在文件上传时记录

```python
# 在 file_api.py 中
session.usage['files']['audio_count'] += 1
session.usage['files']['total_size'] += file_size
```

### 2. 在视频导出时记录

```python
# 在 export_api.py 中
session.usage['exports']['total'] += 1
if success:
    session.usage['exports']['success'] += 1
    session.usage['exports']['total_duration'] += duration
else:
    session.usage['exports']['failed'] += 1
```

### 3. 在AI服务使用时记录

```python
# 在字幕生成时
session.usage['ai_services']['subtitle_generation'] += 1
session.usage['ai_services']['total_audio_duration'] += audio_duration
```

## 使用示例

### 查看使用统计

1. 访问 `http://localhost:5000/usage.html`
2. 系统自动加载当前会话的使用统计
3. 点击"刷新数据"按钮更新统计信息

### 开发者集成

```python
from src.web.services.session_manager import SessionManager

# 获取会话管理器实例
session_mgr = SessionManager()

# 获取会话
session = session_mgr.get_session(session_id)

# 记录文件上传
session.usage['files']['audio_count'] += 1
session.usage['files']['total_size'] += file_size

# 保存会话
session_mgr.save_session(session)
```

## 未来扩展

### 1. 配额限制

可以基于使用统计实现配额限制：

```python
def check_quota(session: UserSession, resource_type: str) -> bool:
    """检查资源配额"""
    limits = {
        'files.total_size': 1024 * 1024 * 1024,  # 1GB
        'exports.total': 100,  # 最多100次导出
        'ai_services.subtitle_generation': 50  # 最多50次字幕生成
    }
    
    current_usage = get_nested_value(session.usage, resource_type)
    limit = limits.get(resource_type)
    
    return current_usage < limit if limit else True
```

### 2. 计费模型

```python
def calculate_cost(usage: dict) -> float:
    """计算使用费用"""
    pricing = {
        'storage_per_gb': 0.1,  # 每GB 0.1元
        'export_per_minute': 0.5,  # 每分钟导出 0.5元
        'ai_subtitle_per_minute': 1.0  # 每分钟字幕 1元
    }
    
    cost = 0
    cost += (usage['files']['total_size'] / 1024**3) * pricing['storage_per_gb']
    cost += (usage['exports']['total_duration'] / 60) * pricing['export_per_minute']
    cost += (usage['ai_services']['total_audio_duration'] / 60) * pricing['ai_subtitle_per_minute']
    
    return cost
```

### 3. 报表导出

```python
def export_usage_report(session_id: str, format: str = 'csv') -> str:
    """导出使用报表"""
    session = session_mgr.get_session(session_id)
    
    if format == 'csv':
        return generate_csv_report(session.usage)
    elif format == 'json':
        return json.dumps(session.usage, indent=2)
    elif format == 'pdf':
        return generate_pdf_report(session.usage)
```

### 4. 实时监控

```python
# WebSocket 实时推送使用统计
@socketio.on('subscribe_usage')
def handle_subscribe_usage(data):
    session_id = data['session_id']
    # 加入房间
    join_room(f'usage_{session_id}')
    
    # 定期推送更新
    while True:
        session = session_mgr.get_session(session_id)
        emit('usage_update', session.usage, room=f'usage_{session_id}')
        time.sleep(5)
```

## 性能考虑

1. **内存优化**：会话数据定期持久化到磁盘
2. **缓存策略**：统计数据可以缓存5分钟
3. **异步记录**：使用后台任务记录使用事件
4. **数据归档**：定期归档历史数据

## 安全性

1. **会话验证**：所有API都需要有效的session_id
2. **权限控制**：用户只能查看自己的使用统计
3. **数据隔离**：每个会话的数据完全隔离
4. **防篡改**：使用统计数据只能通过系统API修改

## 测试

运行测试：

```bash
# 单元测试
pytest tests/web/test_usage_api.py -v

# 集成测试
pytest tests/integration/test_usage_tracking.py -v
```

## 相关文档

- [Web API文档](../api/Web_API文档.md)
- [会话管理文档](./会话管理文档.md)
- [系统架构文档](../architecture/README.md)

## 更新日志

### v3.0.0 (2025-10-30)

- ✅ 初始实现计费统计模块
- ✅ 添加使用统计API
- ✅ 实现统计可视化页面
- ✅ 集成到现有系统中

---

**维护者**: Lecture Video Composer Team  
**最后更新**: 2025-10-30
