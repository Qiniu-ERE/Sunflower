# å®æ—¶å­—å¹•åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

æ¼”è®²è§†é¢‘åˆæˆç³»ç»Ÿå·²å®Œæ•´æ”¯æŒå®æ—¶å­—å¹•æ˜¾ç¤ºåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. **AIå­—å¹•ç”Ÿæˆ**ï¼šä½¿ç”¨Whisper AIä»éŸ³é¢‘è‡ªåŠ¨ç”Ÿæˆä¸­æ–‡å­—å¹•
2. **å®æ—¶å­—å¹•æ˜¾ç¤º**ï¼šæ’­æ”¾æ—¶æ ¹æ®æ—¶é—´è½´åŒæ­¥æ˜¾ç¤ºå­—å¹•
3. **å­—å¹•å¼€å…³æ§åˆ¶**ï¼šç”¨æˆ·å¯éšæ—¶å¼€å¯/å…³é—­å­—å¹•æ˜¾ç¤º
4. **ä¼˜é›…çš„UIè®¾è®¡**ï¼šåŠé€æ˜èƒŒæ™¯ã€æ–‡å­—æè¾¹ã€å“åº”å¼å¸ƒå±€

## æ¶æ„è®¾è®¡

### åç«¯ç»„ä»¶

#### 1. SubtitleService (src/services/subtitle/subtitle_service.py)
- ä½¿ç”¨OpenAI Whisperæ¨¡å‹è¿›è¡Œè¯­éŸ³è¯†åˆ«
- æ”¯æŒå¤šç§æ¨¡å‹ï¼štiny, base, small, medium, large
- ç”ŸæˆSRTå’ŒASSä¸¤ç§å­—å¹•æ ¼å¼
- å¯é…ç½®å­—ä½“ã€é¢œè‰²ã€ä½ç½®ç­‰æ ·å¼

```python
from src.services.subtitle.subtitle_service import SubtitleService, SubtitleConfig

config = SubtitleConfig(
    model='base',
    language='zh',
    font_size=24,
    font_color='white'
)

service = SubtitleService(config)
subtitle_file = service.generate_subtitles(audio_file, output_dir)
```

#### 2. Subtitle API (src/web/api/subtitle_api.py)
æä¾›ä¸¤ä¸ªä¸»è¦æ¥å£ï¼š

**åŠ è½½å­—å¹•**
```
GET /api/subtitle/load/<project_id>?session_id=xxx
```

è¿”å›é¡¹ç›®çš„å­—å¹•æ•°æ®ï¼ˆSRTæ ¼å¼è§£æä¸ºJSONï¼‰ï¼š
```json
{
  "success": true,
  "has_subtitles": true,
  "subtitles": [
    {
      "start": 0.5,
      "end": 3.2,
      "text": "å¤§å®¶å¥½ï¼Œæ¬¢è¿æ¥åˆ°ä»Šå¤©çš„æ¼”è®²"
    },
    ...
  ]
}
```

**ç”Ÿæˆå­—å¹•**
```
POST /api/subtitle/generate/<project_id>
{
  "session_id": "xxx",
  "model": "base",
  "language": "zh"
}
```

### å‰ç«¯ç»„ä»¶

#### 1. Player.js å­—å¹•æ”¯æŒ

**å­—å¹•æ•°æ®ç»“æ„**
```javascript
this.subtitles = [
  {
    start: 0.5,    // å¼€å§‹æ—¶é—´ï¼ˆç§’ï¼‰
    end: 3.2,      // ç»“æŸæ—¶é—´ï¼ˆç§’ï¼‰
    text: "å­—å¹•æ–‡æœ¬"
  }
];
```

**ä¸»è¦æ–¹æ³•**

```javascript
// åŠ è½½å­—å¹•æ•°æ®
player.loadSubtitles(subtitles);

// å¯ç”¨/ç¦ç”¨å­—å¹•
player.setSubtitlesEnabled(true/false);

// ç›‘å¬å­—å¹•æ›´æ–°äº‹ä»¶
player.on('subtitleupdate', (data) => {
  // data.subtitle ä¸ºå½“å‰å­—å¹•æ–‡æœ¬
});
```

**å®æ—¶åŒæ­¥æœºåˆ¶**

æ’­æ”¾å™¨åœ¨`timeupdate`äº‹ä»¶ä¸­è‡ªåŠ¨è°ƒç”¨`_updateSubtitleByTime()`æ–¹æ³•ï¼š

```javascript
_updateSubtitleByTime(time) {
  // æŸ¥æ‰¾å½“å‰æ—¶é—´å¯¹åº”çš„å­—å¹•
  let foundSubtitle = null;
  for (const subtitle of this.subtitles) {
    if (time >= subtitle.start && time <= subtitle.end) {
      foundSubtitle = subtitle;
      break;
    }
  }
  
  // å¦‚æœå­—å¹•å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘æ›´æ–°äº‹ä»¶
  if (foundSubtitle !== this.currentSubtitle) {
    this.currentSubtitle = foundSubtitle;
    this.emit('subtitleupdate', { 
      subtitle: foundSubtitle ? foundSubtitle.text : null 
    });
  }
}
```

#### 2. App.js å­—å¹•é›†æˆ

**åŠ è½½é¡¹ç›®æ—¶è‡ªåŠ¨åŠ è½½å­—å¹•**

```javascript
async openProject(projectId) {
  // ... åŠ è½½é¡¹ç›®é€»è¾‘
  await this.player.loadProject(audioUrl, photoUrls, photoTimestamps);
  
  // å°è¯•åŠ è½½å­—å¹•
  await this.loadProjectSubtitles(projectId);
}
```

**å­—å¹•æ˜¾ç¤ºæ›´æ–°**

```javascript
// ç›‘å¬å­—å¹•æ›´æ–°äº‹ä»¶
this.player.on('subtitleupdate', (data) => {
  this._updateSubtitleDisplay(data.subtitle);
});

// æ›´æ–°DOMæ˜¾ç¤º
_updateSubtitleDisplay(subtitle) {
  const subtitleOverlay = document.getElementById('subtitle-overlay');
  if (subtitle && subtitle.trim()) {
    subtitleOverlay.innerHTML = `
      <div class="subtitle-text">${this._escapeHtml(subtitle)}</div>
    `;
    subtitleOverlay.classList.add('active');
  } else {
    subtitleOverlay.innerHTML = '';
    subtitleOverlay.classList.remove('active');
  }
}
```

**å­—å¹•å¼€å…³æ§åˆ¶**

```javascript
const subtitleToggleBtn = document.getElementById('subtitle-toggle-btn');
subtitleToggleBtn.addEventListener('click', () => {
  const isEnabled = this.player.subtitlesEnabled;
  this.player.setSubtitlesEnabled(!isEnabled);
  
  // æ›´æ–°æŒ‰é’®æ ·å¼
  if (!isEnabled) {
    subtitleToggleBtn.classList.add('active');
    showNotification('å­—å¹•å·²å¼€å¯', 'success');
  } else {
    subtitleToggleBtn.classList.remove('active');
    showNotification('å­—å¹•å·²å…³é—­', 'info');
  }
});
```

#### 3. HTML ç»“æ„ (app.html)

```html
<div class="photo-display">
  <canvas id="photo-canvas"></canvas>
  
  <!-- å­—å¹•æ˜¾ç¤ºå±‚ -->
  <div class="subtitle-overlay" id="subtitle-overlay"></div>
</div>

<!-- å­—å¹•å¼€å…³æŒ‰é’® -->
<button class="btn btn-control btn-icon" 
        id="subtitle-toggle-btn" 
        title="å­—å¹•å¼€å…³" 
        disabled>
  <span class="control-icon">ğŸ’¬</span>
</button>
```

#### 4. CSS æ ·å¼ (player.css)

```css
/* å­—å¹•å®¹å™¨ */
.subtitle-overlay {
  position: absolute;
  bottom: 10%;
  left: 5%;
  right: 5%;
  text-align: center;
  pointer-events: none;
  z-index: 20;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.subtitle-overlay.active {
  opacity: 1;
}

/* å­—å¹•æ–‡æœ¬ */
.subtitle-overlay .subtitle-text {
  display: inline-block;
  padding: 12px 24px;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(10px);
  border-radius: 8px;
  color: white;
  font-size: 1.25rem;
  font-weight: 500;
  line-height: 1.6;
  max-width: 90%;
  word-wrap: break-word;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
```

## ä½¿ç”¨æµç¨‹

### 1. åˆ›å»ºé¡¹ç›®å¹¶ç”Ÿæˆå­—å¹•

```python
# æ–¹å¼1ï¼šé€šè¿‡Webç•Œé¢
# 1. ä¸Šä¼ éŸ³é¢‘å’Œç…§ç‰‡
# 2. åˆ›å»ºé¡¹ç›®
# 3. åœ¨å¯¼å‡ºè®¾ç½®ä¸­å‹¾é€‰"AIç”Ÿæˆå­—å¹•"
# 4. ç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨Whisperç”Ÿæˆå­—å¹•

# æ–¹å¼2ï¼šé€šè¿‡API
POST /api/subtitle/generate/<project_id>
{
  "session_id": "xxx",
  "model": "base",
  "language": "zh"
}
```

### 2. æ’­æ”¾æ—¶æ˜¾ç¤ºå­—å¹•

```javascript
// 1. æ‰“å¼€é¡¹ç›®
app.openProject(projectId);

// 2. ç³»ç»Ÿè‡ªåŠ¨åŠ è½½å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

// 3. ç‚¹å‡»å­—å¹•æŒ‰é’®å¼€å¯æ˜¾ç¤º
// å­—å¹•ä¼šéšæ’­æ”¾è¿›åº¦è‡ªåŠ¨åŒæ­¥æ˜¾ç¤º
```

### 3. æ§åˆ¶å­—å¹•æ˜¾ç¤º

- **å¼€å¯å­—å¹•**ï¼šç‚¹å‡»æ’­æ”¾å™¨æ§åˆ¶æ çš„"ğŸ’¬"æŒ‰é’®
- **å…³é—­å­—å¹•**ï¼šå†æ¬¡ç‚¹å‡»æŒ‰é’®
- **å¿«æ·é”®**ï¼šæš‚ä¸æ”¯æŒï¼ˆå¯æ‰©å±•ï¼‰

## æŠ€æœ¯ç‰¹ç‚¹

### 1. é«˜ç²¾åº¦æ—¶é—´åŒæ­¥
- ä½¿ç”¨`audio.timeupdate`äº‹ä»¶å®ç°å®æ—¶åŒæ­¥
- å­—å¹•åˆ‡æ¢å»¶è¿Ÿ < 100ms
- æ”¯æŒå¿«è¿›/å¿«é€€æ—¶å­—å¹•ç«‹å³æ›´æ–°

### 2. ä¼˜é›…çš„è§†è§‰æ•ˆæœ
- åŠé€æ˜é»‘è‰²èƒŒæ™¯ï¼ˆalpha 0.85ï¼‰
- æ¯›ç»ç’ƒæ•ˆæœï¼ˆbackdrop-filter: blurï¼‰
- æ–‡å­—æè¾¹å¢å¼ºå¯è¯»æ€§
- æ·¡å…¥æ·¡å‡ºåŠ¨ç”»ï¼ˆ0.3s transitionï¼‰

### 3. å“åº”å¼è®¾è®¡
- æ¡Œé¢ç«¯ï¼š1.25rem å­—å·
- å¹³æ¿ç«¯ï¼š1rem å­—å·
- æ‰‹æœºç«¯ï¼š0.875rem å­—å·
- è‡ªåŠ¨æ¢è¡Œï¼Œæœ€å¤§å®½åº¦90%

### 4. æ€§èƒ½ä¼˜åŒ–
- ä»…åœ¨å­—å¹•å˜åŒ–æ—¶æ›´æ–°DOM
- ä½¿ç”¨CSS transformè€Œéä½ç½®å±æ€§
- é¿å…ä¸å¿…è¦çš„é‡ç»˜å’Œå›æµ

## é…ç½®é€‰é¡¹

### Whisperæ¨¡å‹é€‰æ‹©

| æ¨¡å‹ | å¤§å° | é€Ÿåº¦ | å‡†ç¡®åº¦ | æ¨èåœºæ™¯ |
|------|------|------|--------|----------|
| tiny | 39M | æå¿« | è¾ƒä½ | å¿«é€Ÿæµ‹è¯• |
| base | 74M | å¿« | ä¸­ç­‰ | æ—¥å¸¸ä½¿ç”¨ |
| small | 244M | ä¸­ç­‰ | è¾ƒé«˜ | ç”Ÿäº§ç¯å¢ƒ |
| medium | 769M | æ…¢ | é«˜ | é«˜è´¨é‡éœ€æ±‚ |
| large | 1550M | å¾ˆæ…¢ | æœ€é«˜ | ä¸“ä¸šåœºæ™¯ |

**å»ºè®®**ï¼š
- å¼€å‘æµ‹è¯•ï¼šä½¿ç”¨ `base` æ¨¡å‹
- ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ `medium` æ¨¡å‹
- ä¸­æ–‡è¯†åˆ«ï¼šå»ºè®® `medium` æˆ– `large`

### å­—å¹•æ ·å¼é…ç½®

```python
config = SubtitleConfig(
    model='base',           # Whisperæ¨¡å‹
    language='zh',          # è¯­è¨€ä»£ç 
    font_name='Arial',      # å­—ä½“
    font_size=24,           # å­—ä½“å¤§å°
    font_color='white',     # å­—ä½“é¢œè‰²
    outline_color='black',  # æè¾¹é¢œè‰²
    outline_width=2,        # æè¾¹å®½åº¦
    position='bottom'       # ä½ç½®ï¼šbottom/top/center
)
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šå­—å¹•ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **ï¼š
1. é¡¹ç›®æ²¡æœ‰å­—å¹•æ–‡ä»¶
2. å­—å¹•æŒ‰é’®æœªå¯ç”¨
3. å­—å¹•å¼€å…³å…³é—­

**è§£å†³æ–¹æ³•**ï¼š
```javascript
// æ£€æŸ¥æ˜¯å¦åŠ è½½äº†å­—å¹•
console.log('å­—å¹•æ•°æ®:', player.subtitles);

// æ£€æŸ¥å­—å¹•å¼€å…³çŠ¶æ€
console.log('å­—å¹•å·²å¯ç”¨:', player.subtitlesEnabled);

// æ‰‹åŠ¨å¯ç”¨å­—å¹•
player.setSubtitlesEnabled(true);
```

### é—®é¢˜2ï¼šå­—å¹•ä¸åŒæ­¥

**å¯èƒ½åŸå› **ï¼š
1. éŸ³é¢‘æ—¶é—´ä¸å­—å¹•æ—¶é—´ä¸åŒ¹é…
2. SRTæ–‡ä»¶æ—¶é—´ç é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š
```javascript
// æ£€æŸ¥å½“å‰æ—¶é—´å’Œå­—å¹•
player.on('timeupdate', ({ currentTime }) => {
  console.log('å½“å‰æ—¶é—´:', currentTime);
  console.log('å½“å‰å­—å¹•:', player.currentSubtitle);
});
```

### é—®é¢˜3ï¼šWhisperç”Ÿæˆå¤±è´¥

**å¯èƒ½åŸå› **ï¼š
1. Whisperæœªå®‰è£…
2. æ¨¡å‹ä¸‹è½½å¤±è´¥ï¼ˆSSLè¯ä¹¦é—®é¢˜ï¼‰
3. éŸ³é¢‘æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ

**è§£å†³æ–¹æ³•**ï¼š
```bash
# å®‰è£…Whisper
pip install openai-whisper

# å¦‚æœé‡åˆ°SSLé—®é¢˜ï¼Œæ‰‹åŠ¨ä¸‹è½½æ¨¡å‹
# æ¨¡å‹ä½ç½®ï¼š~/.cache/whisper/
```

## æ‰©å±•åŠŸèƒ½

### è®¡åˆ’ä¸­çš„åŠŸèƒ½

1. **å­—å¹•ç¼–è¾‘**
   - åœ¨çº¿ç¼–è¾‘å­—å¹•æ–‡æœ¬
   - è°ƒæ•´æ—¶é—´è½´
   - æ‰¹é‡æ›¿æ¢

2. **å¤šè¯­è¨€æ”¯æŒ**
   - è‡ªåŠ¨è¯†åˆ«è¯­è¨€
   - åŒè¯­å­—å¹•æ˜¾ç¤º
   - å­—å¹•ç¿»è¯‘

3. **å­—å¹•æ ·å¼å®šåˆ¶**
   - ç”¨æˆ·è‡ªå®šä¹‰å­—ä½“
   - é¢œè‰²é€‰æ‹©
   - ä½ç½®è°ƒæ•´

4. **å­—å¹•å¯¼å…¥å¯¼å‡º**
   - æ”¯æŒæ›´å¤šå­—å¹•æ ¼å¼
   - å¯¼å…¥å¤–éƒ¨å­—å¹•
   - å¯¼å‡ºå­—å¹•æ–‡ä»¶

## API å‚è€ƒ

### SubtitleService

```python
class SubtitleService:
    def generate_subtitles(
        self, 
        audio_file: Path, 
        output_dir: Path
    ) -> Optional[Path]:
        """ç”Ÿæˆå­—å¹•æ–‡ä»¶"""
        
    def get_transcript_text(
        self, 
        audio_file: Path
    ) -> Optional[str]:
        """è·å–çº¯æ–‡æœ¬è½¬å½•"""
        
    def embed_subtitles(
        self, 
        video_file: Path, 
        subtitle_file: Path,
        output_file: Path
    ) -> Path:
        """å°†å­—å¹•åµŒå…¥è§†é¢‘"""
```

### Player API

```javascript
class LecturePlayer {
  // åŠ è½½å­—å¹•
  loadSubtitles(subtitleData: Array): void
  
  // å¯ç”¨/ç¦ç”¨å­—å¹•
  setSubtitlesEnabled(enabled: boolean): void
  
  // äº‹ä»¶
  on('subtitlesloaded', ({ count }) => {})
  on('subtitleupdate', ({ subtitle }) => {})
  on('subtitlestoggle', ({ enabled }) => {})
}
```

## æ€»ç»“

å®æ—¶å­—å¹•åŠŸèƒ½å·²å®Œæ•´å®ç°å¹¶é›†æˆåˆ°æ’­æ”¾å™¨ä¸­ï¼ŒåŒ…æ‹¬ï¼š

âœ… AIå­—å¹•ç”Ÿæˆï¼ˆWhisperï¼‰  
âœ… å®æ—¶åŒæ­¥æ˜¾ç¤º  
âœ… ç”¨æˆ·æ§åˆ¶å¼€å…³  
âœ… ä¼˜é›…çš„UIè®¾è®¡  
âœ… å“åº”å¼å¸ƒå±€  
âœ… æ€§èƒ½ä¼˜åŒ–  

ç”¨æˆ·åªéœ€ï¼š
1. åˆ›å»ºé¡¹ç›®å¹¶ç”Ÿæˆå­—å¹•ï¼ˆæˆ–å¯¼å‡ºæ—¶å‹¾é€‰AIå­—å¹•ï¼‰
2. æ‰“å¼€é¡¹ç›®
