# 多平台部署指南

> 针对不同操作系统的详细部署说明

---

## 📋 目录

- [Windows 部署](#windows-部署)
- [macOS 部署](#macos-部署)
- [Linux 部署](#linux-部署)
- [Docker 跨平台部署](#docker-跨平台部署)
- [平台差异对照](#平台差异对照)
- [故障排查](#故障排查)

---

## Windows 部署

### 📦 系统要求

**最低配置**：
```
操作系统: Windows 10 (64位) 或更高
Python:   3.8 或更高
内存:     4GB
硬盘:     10GB 可用空间
```

**推荐配置**：
```
操作系统: Windows 11 (64位)
Python:   3.10 或更高
内存:     8GB 或更高
硬盘:     50GB SSD
```

### 🔧 环境准备

#### 1. 安装 Python

**方法 1：使用官方安装包**

```powershell
# 下载 Python 3.10+
# 访问：https://www.python.org/downloads/windows/

# 安装时勾选：
☑️ Add Python to PATH
☑️ Install pip
☑️ Install for all users
```

**验证安装**：
```powershell
python --version
pip --version
```

**方法 2：使用 Chocolatey**

```powershell
# 以管理员身份运行 PowerShell
Set-ExecutionPolicy Bypass -Scope Process -Force
iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

# 安装 Python
choco install python310 -y
```

#### 2. 安装 FFmpeg

**方法 1：手动安装**

```powershell
# 1. 下载 FFmpeg
# 访问：https://www.gyan.dev/ffmpeg/builds/

# 2. 解压到 C:\ffmpeg

# 3. 添加到环境变量
$env:Path += ";C:\ffmpeg\bin"
[Environment]::SetEnvironmentVariable("Path", $env:Path, "Machine")

# 4. 验证
ffmpeg -version
```

**方法 2：使用 Chocolatey**

```powershell
choco install ffmpeg -y
```

#### 3. 安装 Git

```powershell
# 使用 Chocolatey
choco install git -y

# 或下载安装包
# https://git-scm.com/download/win
```

### 🚀 项目部署

#### 1. 克隆项目

```powershell
# 使用 Git Bash 或 PowerShell
cd C:\Users\YourName\Projects
git clone https://github.com/Qiniu-ERE/Sunflower.git
cd Sunflower\lecture-video-composer
```

#### 2. 创建虚拟环境

```powershell
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
.\venv\Scripts\Activate.ps1

# 如果执行策略限制，运行：
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

#### 3. 配置pip加速（可选）

```powershell
# 国内服务器推荐使用清华大学镜像源加速
# 创建 pip 配置目录
mkdir $env:APPDATA\pip

# 创建配置文件
@"
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
"@ | Out-File -FilePath $env:APPDATA\pip\pip.ini -Encoding utf8
```

#### 4. 安装依赖

```powershell
# 升级 pip
python -m pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt

# 如果安装失败，尝试：
pip install -r requirements.txt --use-pep517
```

#### 5. 配置环境

```powershell
# 复制配置文件
Copy-Item .env.example .env

# 编辑配置（使用记事本或 VSCode）
notepad .env
```

#### 6. 启动服务

```powershell
# 开发模式
python run_web.py

# 生产模式
$env:FLASK_ENV="production"
python run_web.py
```

### 🔥 Windows 防火墙配置

```powershell
# 允许 Python 通过防火墙
New-NetFirewallRule -DisplayName "Python Web Server" `
  -Direction Inbound `
  -Program "C:\Path\To\Python\python.exe" `
  -Action Allow

# 或允许端口 5000
New-NetFirewallRule -DisplayName "Port 5000" `
  -Direction Inbound `
  -LocalPort 5000 `
  -Protocol TCP `
  -Action Allow
```

### 📝 Windows 服务配置（生产环境）

#### 使用 NSSM

```powershell
# 下载 NSSM
# https://nssm.cc/download

# 安装服务
nssm install LectureVideoComposer "C:\Path\To\Python\python.exe"
nssm set LectureVideoComposer AppDirectory "C:\Path\To\Project"
nssm set LectureVideoComposer AppParameters "run_web.py"

# 启动服务
nssm start LectureVideoComposer

# 查看状态
nssm status LectureVideoComposer
```

#### 使用任务计划程序

```powershell
# 创建启动脚本 start.bat
@echo off
cd C:\Path\To\Project
call venv\Scripts\activate.bat
python run_web.py
```

**配置任务**：
1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：系统启动时
4. 操作：启动程序 `C:\Path\To\start.bat`

---

## macOS 部署

### 📦 系统要求

**支持版本**：
```
macOS Big Sur (11.0) 或更高
macOS Monterey (12.0) 推荐
macOS Ventura (13.0) 最佳
```

### 🔧 环境准备

#### 1. 安装 Homebrew

```bash
# 安装 Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 验证安装
brew --version
```

#### 2. 安装 Python

```bash
# 使用 Homebrew 安装
brew install python@3.10

# 添加到 PATH（如果需要）
echo 'export PATH="/usr/local/opt/python@3.10/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# 验证
python3 --version
pip3 --version
```

#### 3. 安装 FFmpeg

```bash
# 使用 Homebrew
brew install ffmpeg

# 验证
ffmpeg -version
```

#### 4. 安装 Git

```bash
# macOS 通常自带 git，如果没有：
brew install git
```

### 🚀 项目部署

#### 1. 克隆项目

```bash
cd ~/Projects
git clone https://github.com/Qiniu-ERE/Sunflower.git
cd Sunflower/lecture-video-composer
```

#### 2. 创建虚拟环境

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 验证
which python
# 应该显示虚拟环境路径
```

#### 3. 配置pip加速（可选）

```bash
# 国内服务器推荐使用清华大学镜像源加速
mkdir -p ~/.pip
echo -e "[global]\nindex-url = https://pypi.tuna.tsinghua.edu.cn/simple" > ~/.pip/pip.conf
```

#### 4. 安装依赖

```bash
# 升级 pip
pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt

# M1/M2 芯片特殊处理
# 如果遇到编译错误：
arch -arm64 pip install -r requirements.txt
```

#### 5. 配置环境

```bash
# 复制配置文件
cp .env.example .env

# 编辑配置
nano .env
# 或使用 VSCode
code .env
```

#### 6. 启动服务

```bash
# 开发模式
python run_web.py

# 生产模式
export FLASK_ENV=production
python run_web.py
```

### 🔥 macOS 防火墙配置

```bash
# 允许入站连接（图形界面）
# 系统偏好设置 > 安全性与隐私 > 防火墙 > 防火墙选项
# 添加 Python 到允许列表

# 或使用命令行
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/local/bin/python3
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /usr/local/bin/python3
```

### 📝 macOS 服务配置（LaunchAgent）

#### 创建服务文件

```bash
# 创建 plist 文件
nano ~/Library/LaunchAgents/com.lecture.video.composer.plist
```

**配置内容**：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.lecture.video.composer</string>
    
    <key>ProgramArguments</key>
    <array>
        <string>/Users/YourName/Projects/Sunflower/lecture-video-composer/venv/bin/python</string>
        <string>/Users/YourName/Projects/Sunflower/lecture-video-composer/run_web.py</string>
    </array>
    
    <key>WorkingDirectory</key>
    <string>/Users/YourName/Projects/Sunflower/lecture-video-composer</string>
    
    <key>RunAtLoad</key>
    <true/>
    
    <key>KeepAlive</key>
    <true/>
    
    <key>StandardOutPath</key>
    <string>/Users/YourName/Projects/Sunflower/lecture-video-composer/logs/stdout.log</string>
    
    <key>StandardErrorPath</key>
    <string>/Users/YourName/Projects/Sunflower/lecture-video-composer/logs/stderr.log</string>
</dict>
</plist>
```

**加载服务**：

```bash
# 加载服务
launchctl load ~/Library/LaunchAgents/com.lecture.video.composer.plist

# 启动服务
launchctl start com.lecture.video.composer

# 查看状态
launchctl list | grep lecture

# 停止服务
launchctl stop com.lecture.video.composer

# 卸载服务
launchctl unload ~/Library/LaunchAgents/com.lecture.video.composer.plist
```

---

## Linux 部署

### 📦 Ubuntu/Debian

#### 系统要求

```
Ubuntu 20.04 LTS 或更高
Ubuntu 22.04 LTS 推荐
Debian 11 或更高
```

#### 环境准备

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    ffmpeg \
    build-essential \
    libssl-dev \
    libffi-dev \
    python3-dev

# 验证安装
python3 --version
pip3 --version
ffmpeg -version
```

#### 项目部署

```bash
# 1. 克隆项目
cd /opt
sudo git clone https://github.com/Qiniu-ERE/Sunflower.git
sudo chown -R $USER:$USER Sunflower
cd Sunflower/lecture-video-composer

# 2. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 3. 配置pip加速（国内服务器推荐）
mkdir -p ~/.pip
echo -e "[global]\nindex-url = https://pypi.tuna.tsinghua.edu.cn/simple" > ~/.pip/pip.conf

# 4. 安装依赖
pip install --upgrade pip
pip install -r requirements.txt

# 4. 配置
cp .env.example .env
nano .env

# 5. 启动
python run_web.py
```

#### Systemd 服务配置

```bash
# 创建服务文件
sudo nano /etc/systemd/system/lecture-video-composer.service
```

**服务配置**：

```ini
[Unit]
Description=Lecture Video Composer Service
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/Sunflower/lecture-video-composer
Environment="PATH=/opt/Sunflower/lecture-video-composer/venv/bin"
Environment="FLASK_ENV=production"
ExecStart=/opt/Sunflower/lecture-video-composer/venv/bin/python run_web.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**启动服务**：

```bash
# 重新加载配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start lecture-video-composer

# 设置开机自启
sudo systemctl enable lecture-video-composer

# 查看状态
sudo systemctl status lecture-video-composer

# 查看日志
sudo journalctl -u lecture-video-composer -f
```

### 📦 CentOS/RHEL

#### 环境准备

```bash
# CentOS 8 / RHEL 8
sudo dnf update -y
sudo dnf install -y \
    python3 \
    python3-pip \
    python3-devel \
    git \
    gcc \
    make \
    openssl-devel

# 安装 FFmpeg（需要 EPEL）
sudo dnf install -y epel-release
sudo dnf install -y ffmpeg

# CentOS 7 / RHEL 7
sudo yum update -y
sudo yum install -y \
    python3 \
    python3-pip \
    python3-devel \
    git \
    gcc \
    make

# FFmpeg 需要额外仓库
sudo yum install -y epel-release
sudo rpm -v --import http://li.nux.ro/download/nux/RPM-GPG-KEY-nux.ro
sudo rpm -Uvh http://li.nux.ro/download/nux/dextop/el7/x86_64/nux-dextop-release-0-5.el7.nux.noarch.rpm
sudo yum install -y ffmpeg
```

#### 项目部署

```bash
# 1. 克隆项目
cd /opt
sudo git clone https://github.com/Qiniu-ERE/Sunflower.git
sudo chown -R $USER:$USER Sunflower
cd Sunflower/lecture-video-composer

# 2. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 3. 配置pip加速（国内服务器推荐）
mkdir -p ~/.pip
echo -e "[global]\nindex-url = https://pypi.tuna.tsinghua.edu.cn/simple" > ~/.pip/pip.conf

# 4. 安装依赖
pip install --upgrade pip
pip install -r requirements.txt

# 5. 配置
cp .env.example .env
nano .env

# 6. 启动
python run_web.py
```

### 📦 openEuler

#### 系统要求

```
openEuler 20.03 LTS 或更高
openEuler 22.03 LTS 推荐
```

#### 环境准备

```bash
# 更新系统
sudo dnf update -y

# 安装基础依赖
sudo dnf install -y \
    python3 \
    python3-pip \
    python3-devel \
    git \
    gcc \
    gcc-c++ \
    make \
    openssl-devel \
    libffi-devel

# 安装 FFmpeg
sudo dnf install -y ffmpeg

# 验证安装
python3 --version
pip3 --version
ffmpeg -version
```

#### 项目部署

```bash
# 1. 克隆项目
cd /opt
sudo git clone https://github.com/Qiniu-ERE/Sunflower.git
sudo chown -R $USER:$USER Sunflower
cd Sunflower/lecture-video-composer

# 2. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 3. 配置pip加速（国内服务器推荐）
mkdir -p ~/.pip
echo -e "[global]\nindex-url = https://pypi.tuna.tsinghua.edu.cn/simple" > ~/.pip/pip.conf

# 4. 安装依赖
pip install --upgrade pip
pip install -r requirements.txt

# 5. 配置
cp .env.example .env
nano .env

# 6. 启动
python run_web.py
```

#### Systemd 服务配置

```bash
# 创建服务文件
sudo nano /etc/systemd/system/lecture-video-composer.service
```

**服务配置**（与其他Linux发行版相同）：

```ini
[Unit]
Description=Lecture Video Composer Service
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/Sunflower/lecture-video-composer
Environment="PATH=/opt/Sunflower/lecture-video-composer/venv/bin"
Environment="FLASK_ENV=production"
ExecStart=/opt/Sunflower/lecture-video-composer/venv/bin/python run_web.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**启动服务**：

```bash
# 重新加载配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start lecture-video-composer

# 设置开机自启
sudo systemctl enable lecture-video-composer

# 查看状态
sudo systemctl status lecture-video-composer

# 查看日志
sudo journalctl -u lecture-video-composer -f
```

#### 防火墙配置

```bash
# openEuler 默认使用 firewalld
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload

# 查看开放的端口
sudo firewall-cmd --list-ports
```

#### SELinux 配置

```bash
# 检查 SELinux 状态
getenforce

# 临时禁用（测试用）
sudo setenforce 0

# 永久配置
sudo nano /etc/selinux/config
# 设置：SELINUX=permissive

# 或配置 SELinux 策略
sudo setsebool -P httpd_can_network_connect 1
sudo semanage port -a -t http_port_t -p tcp 5000

# 恢复文件上下文
sudo restorecon -R /opt/Sunflower
```

---

## Docker 跨平台部署

### 🐳 Docker 安装

#### Windows

```powershell
# 下载 Docker Desktop for Windows
# https://www.docker.com/products/docker-desktop

# 或使用 Chocolatey
choco install docker-desktop -y

# 启动 Docker Desktop 并验证
docker --version
docker-compose --version
```

#### macOS

```bash
# 下载 Docker Desktop for Mac
# https://www.docker.com/products/docker-desktop

# 或使用 Homebrew
brew install --cask docker

# 启动 Docker.app 并验证
docker --version
docker-compose --version
```

#### Linux

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
newgrp docker

# CentOS/RHEL
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io
sudo systemctl start docker
sudo systemctl enable docker

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 📦 使用 Docker 部署

#### 1. 构建镜像

```bash
# 克隆项目
git clone https://github.com/Qiniu-ERE/Sunflower.git
cd Sunflower/lecture-video-composer

# 构建镜像
docker build -t lecture-video-composer:latest .

# 查看镜像
docker images | grep lecture
```

#### 2. 运行容器

```bash
# 简单运行
docker run -d \
  --name lecture-composer \
  -p 5000:5000 \
  -v $(pwd)/data:/app/data \
  lecture-video-composer:latest

# 带环境变量
docker run -d \
  --name lecture-composer \
  -p 5000:5000 \
  -e FLASK_ENV=production \
  -e MAX_UPLOAD_SIZE=500 \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/logs:/app/logs \
  lecture-video-composer:latest

# 查看日志
docker logs -f lecture-composer

# 停止容器
docker stop lecture-composer

# 重启容器
docker restart lecture-composer
```

#### 3. 使用 Docker Compose

**创建 `docker-compose.yml`**：

```yaml
version: '3.8'

services:
  app:
    build: .
    container_name: lecture-composer
    ports:
      - "5000:5000"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - FLASK_ENV=production
      - MAX_UPLOAD_SIZE=500
      - ALLOWED_EXTENSIONS=jpg,jpeg,png,mp3,wav
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    container_name: lecture-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - app
    restart: unless-stopped
```

**启动服务**：

```bash
# 启动所有服务
docker-compose up -d

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 重启服务
docker-compose restart

# 停止服务
docker-compose down

# 重新构建并启动
docker-compose up -d --build
```

### 🔧 Dockerfile 示例

```dockerfile
FROM python:3.10-slim

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    ffmpeg \
    git \
    && rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY requirements.txt .

# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制项目文件
COPY . .

# 创建数据目录
RUN mkdir -p data/uploads data/projects data/exports logs

# 暴露端口
EXPOSE 5000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:5000/api/health')"

# 启动命令
CMD ["python", "run_web.py"]
```

---

## 平台差异对照

### 📊 命令对照表

| 功能 | Windows | macOS | Linux |
|------|---------|-------|-------|
| **Python 命令** | `python` | `python3` | `python3` |
| **Pip 命令** | `pip` | `pip3` | `pip3` |
| **激活虚拟环境** | `.\venv\Scripts\Activate.ps1` | `source venv/bin/activate` | `source venv/bin/activate` |
| **查看进程** | `tasklist` | `ps aux` | `ps aux` |
| **结束进程** | `taskkill /PID <pid>` | `kill <pid>` | `kill <pid>` |
| **查看端口** | `netstat -ano` | `lsof -i :5000` | `netstat -tulpn` |
| **环境变量** | `$env:VAR="value"` | `export VAR=value` | `export VAR=value` |
| **文件权限** | `icacls` | `chmod` | `chmod` |
| **服务管理** | `sc.exe` / NSSM | `launchctl` | `systemctl` |

### 📁 路径对照表

| 类型 | Windows | macOS | Linux |
|------|---------|-------|-------|
| **项目路径** | `C:\Users\Name\Projects` | `/Users/Name/Projects` | `/opt` 或 `/home/user` |
| **Python 路径** | `C:\Python310\python.exe` | `/usr/local/bin/python3` | `/usr/bin/python3` |
| **虚拟环境** | `venv\Scripts` | `venv/bin` | `venv/bin` |
| **日志路径** | `C:\ProgramData\Logs` | `/var/log` 或 `~/Library/Logs` | `/var/log` |
| **配置路径** | `%APPDATA%` | `~/Library/Application Support` | `/etc` 或 `~/.config` |
| **临时文件** | `%TEMP%` | `/tmp` | `/tmp` |

### 🔧 配置文件对照

| 功能 | Windows | macOS | Linux |
|------|---------|-------|-------|
| **服务配置** | `*.xml` (NSSM) | `*.plist` (LaunchAgent) | `*.service` (Systemd) |
| **环境变量** | 系统属性 | `~/.zshrc` / `~/.bash_profile` | `~/.bashrc` / `/etc/environment` |
| **防火墙** | Windows Defender | 系统偏好设置 | `ufw` / `firewalld` |
| **Web 服务器** | IIS / Apache | Apache / Nginx | Apache / Nginx |

### ⚙️ 服务管理对照

| 操作 | Windows (NSSM) | macOS (LaunchAgent) | Linux (Systemd) |
|------|----------------|---------------------|-----------------|
| **安装服务** | `nssm install <name>` | `launchctl load <plist>` | `systemctl enable <service>` |
| **启动服务** | `nssm start <name>` | `launchctl start <label>` | `systemctl start <service>` |
| **停止服务** | `nssm stop <name>` | `launchctl stop <label>` | `systemctl stop <service>` |
| **重启服务** | `nssm restart <name>` | `launchctl stop + start` | `systemctl restart <service>` |
| **查看状态** | `nssm status <name>` | `launchctl list` | `systemctl status <service>` |
| **查看日志** | 日志文件 | `~/Library/Logs` | `journalctl -u <service>` |

---

## 故障排查

### 🔍 Windows 常见问题

#### 1. PowerShell 执行策略限制

**问题**：无法运行 `.ps1` 脚本

**解决**：
```powershell
# 查看当前策略
Get-ExecutionPolicy

# 临时允许
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process

# 永久允许（需要管理员）
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

#### 2. Python 未添加到 PATH

**问题**：命令行无法识别 `python` 命令

**解决**：
```powershell
# 手动添加到 PATH
$env:Path += ";C:\Python310;C:\Python310\Scripts"

# 永久添加（系统环境变量）
[Environment]::SetEnvironmentVariable("Path", $env:Path + ";C:\Python310;C:\Python310\Scripts", "Machine")
```

#### 3. FFmpeg 未找到

**问题**：`ffmpeg: command not found`

**解决**：
```powershell
# 下载并解压 FFmpeg
# 添加到 PATH
$env:Path += ";C:\ffmpeg\bin"
[Environment]::SetEnvironmentVariable("Path", $env:Path, "Machine")
```

#### 4. 端口被占用

**问题**：`Address already in use: 5000`

**解决**：
```powershell
# 查找占用端口的进程
netstat -ano | findstr :5000

# 结束进程
taskkill /PID <PID> /F

# 或更改应用端口
$env:FLASK_PORT=5001
python run_web.py
```

### 🔍 macOS 常见问题

#### 1. Homebrew 安装失败

**问题**：安装 Homebrew 时网络错误

**解决**：
```bash
# 使用国内镜像
export HOMEBREW_BREW_GIT_REMOTE="https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git"
/bin/bash -c "$(curl -fsSL https://cdn.jsdelivr.net/gh/ineo6/homebrew-install/install.sh)"
```

#### 2. Python 版本冲突

**问题**：系统自带 Python 2.7

**解决**：
```bash
# 使用 python3
python3 --version

# 创建别名
echo 'alias python=python3' >> ~/.zshrc
echo 'alias pip=pip3' >> ~/.zshrc
source ~/.zshrc
```

#### 3. M1/M2 芯片兼容性

**问题**：某些包无法安装

**解决**：
```bash
# 使用 Rosetta
arch -x86_64 pip install <package>

# 或指定架构
arch -arm64 pip install <package>

# 安装 Rosetta（如果没有）
softwareupdate --install-rosetta
```

#### 4. 权限问题

**问题**：`Permission denied`

**解决**：
```bash
# 修改文件权限
chmod +x run_web.py

# 修改目录权限
sudo chown -R $USER:staff ~/Projects/Sunflower

# LaunchAgent 权限
chmod 644 ~/Library/LaunchAgents/com.lecture.video.composer.plist
```

### 🔍 Linux 常见问题

#### 1. Git 克隆失败

**问题**：`fatal: unable to access 'https://github.com/.../': HTTP/2 stream 1 was not closed cleanly`

**解决**：
```bash
# 方法1：禁用 HTTP/2
git config --global http.version HTTP/1.1
git clone https://github.com/Qiniu-ERE/Sunflower.git

# 方法2：增加缓冲区
git config --global http.postBuffer 524288000

# 方法3：使用 SSH（如果有密钥）
git clone git@github.com:Qiniu-ERE/Sunflower.git

# 方法4：使用代理（如果有）
git config --global http.proxy http://proxy.example.com:8080

# 方法5：重试几次
# 网络不稳定时多尝试几次通常能成功
```

#### 2. 依赖安装失败

**问题**：编译错误或缺少库

**解决**：
```bash
# Ubuntu/Debian
sudo apt install -y build-essential python3-dev libssl-dev libffi-dev

# CentOS/RHEL/openEuler
sudo yum groupinstall -y "Development Tools"
sudo yum install -y python3-devel openssl-devel libffi-devel

# 或在 openEuler 上使用 dnf
sudo dnf groupinstall -y "Development Tools"
sudo dnf install -y python3-devel openssl-devel libffi-devel
```

#### 2. FFmpeg 版本过旧

**问题**：FFmpeg 功能不支持

**解决**：
```bash
# 添加 PPA（Ubuntu）
sudo add-apt-repository ppa:jonathonf/ffmpeg-4
sudo apt update
sudo apt install ffmpeg

# 或从源码编译
# https://trac.ffmpeg.org/wiki/CompilationGuide
```

#### 3. SELinux 阻止

**问题**：服务无法启动或访问文件

**解决**：
```bash
# 查看 SELinux 日志
sudo ausearch -m avc -ts recent

# 临时禁用
sudo setenforce 0

# 生成策略
sudo audit2allow -a -M mylectureapp
sudo semodule -i mylectureapp.pp

# 或设置为 permissive
sudo semanage permissive -a httpd_t
```

#### 4. Systemd 服务失败

**问题**：服务无法启动

**解决**：
```bash
# 查看详细日志
sudo journalctl -u lecture-video-composer -n 50 --no-pager

# 检查服务配置
sudo systemctl cat lecture-video-composer

# 重新加载配置
sudo systemctl daemon-reload

# 检查语法
sudo systemd-analyze verify /etc/systemd/system/lecture-video-composer.service
```

### 🔍 Docker 常见问题

#### 1. Docker Desktop 无法启动（Windows/macOS）

**问题**：Docker Desktop 启动失败

**解决**：
```bash
# Windows：确保 WSL2 已安装
wsl --install
wsl --set-default-version 2

# macOS：重置 Docker
rm -rf ~/Library/Group\ Containers/group.com.docker
rm -rf ~/Library/Containers/com.docker.docker
# 重新安装 Docker Desktop
```

#### 2. 容器内权限问题

**问题**：无法写入挂载的卷

**解决**：
```bash
# 检查文件权限
ls -la ./data

# 修改权限
chmod -R 777 ./data

# 或使用用户映射（docker-compose.yml）
user: "${UID}:${GID}"
```

#### 3. 网络连接问题

**问题**：容器无法访问外网

**解决**：
```bash
# 检查 DNS
docker run --rm busybox nslookup google.com

# 自定义 DNS（docker-compose.yml）
dns:
  - 8.8.8.8
  - 8.8.4.4

# 或修改 /etc/docker/daemon.json
{
  "dns": ["8.8.8.8", "8.8.4.4"]
}
sudo systemctl restart docker
```

#### 4. 镜像构建失败

**问题**：`pip install` 超时

**解决**：
```dockerfile
# 使用国内镜像（Dockerfile）
RUN pip install --no-cache-dir \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    -r requirements.txt
```

### 🔍 通用问题

#### 1. 内存不足

**问题**：应用崩溃或 OOM

**解决**：
```bash
# 检查内存使用
# Windows
Get-Process python | Format-List

# macOS/Linux
ps aux | grep python
top -p $(pgrep python)

# 增加虚拟内存（Windows）
# 系统属性 > 高级 > 性能 > 设置 > 高级 > 虚拟内存

# 增加 swap（Linux）
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

#### 2. 文件上传失败

**问题**：上传大文件失败

**解决**：
```bash
# 检查配置
cat .env | grep MAX_UPLOAD_SIZE

# 修改限制
export MAX_UPLOAD_SIZE=1000  # MB

# Nginx 配置（如果使用）
client_max_body_size 1000M;
```

#### 3. FFmpeg 错误

**问题**：视频导出失败

**解决**：
```bash
# 验证 FFmpeg
ffmpeg -version
ffmpeg -codecs | grep h264

# 测试编码
ffmpeg -i input.mp4 -c:v libx264 -preset fast test.mp4

# 查看错误日志
tail -f logs/error.log
```

#### 4. 端口冲突

**问题**：端口已被占用

**解决**：
```bash
# Windows
netstat -ano | findstr :5000
taskkill /PID <PID> /F

# macOS
lsof -ti:5000 | xargs kill -9

# Linux
sudo lsof -i :5000
sudo kill $(sudo lsof -t -i:5000)

# 或修改应用端口
export FLASK_PORT=5001
```

---

## 📚 相关文档

- [部署指南](./部署指南.md) - 通用部署说明
- [快速上手指南](../user-guide/快速上手指南.md) - 新手入门
- [FAQ](../user-guide/FAQ.md) - 常见问题解答
- [集成测试指南](../testing/集成测试指南.md) - 测试部署

---

## 📝 更新日志

### v2.2.2 (2025-10-26)

- ✅ **新增 openEuler 部署支持**
- ✅ 添加 openEuler 20.03/22.03 LTS 环境准备说明
- ✅ 添加 openEuler 使用 dnf 安装 FFmpeg 的详细步骤
- ✅ 添加 openEuler 防火墙（firewalld）配置指南
- ✅ 添加 openEuler SELinux 配置说明
- ✅ 完善 Linux 发行版支持（Ubuntu/Debian/CentOS/RHEL/openEuler）

### v2.2.1 (2025-10-26)

- ✅ 新增完整的多平台部署指南
- ✅ 添加 Windows/macOS/Linux 详细说明
- ✅ 添加 Docker 跨平台部署
- ✅ 添加平台差异对照表
- ✅ 添加详细的故障排查指南
- ✅ 涵盖所有主流操作系统和部署方式

---

**文档完成度**: 100% ✅

最后更新：2025年10月26日
