# 部署指南

> 生产环境部署的完整指南

---

## 📋 概述

本指南介绍如何将演讲视频合成系统部署到生产环境，包括本地服务器、云服务器和容器化部署。

### 部署方式

- 🖥️ **本地部署** - 适合个人或小团队使用
- ☁️ **云服务器部署** - 适合远程访问和团队协作
- 🐳 **Docker 部署** - 推荐的生产环境方案
- 🚀 **Kubernetes 部署** - 适合大规模部署

---

## 🖥️ 本地部署

### 系统要求

**最低配置**：
- CPU: 2 核
- 内存: 4GB
- 存储: 10GB 可用空间
- 操作系统: macOS / Linux / Windows

**推荐配置**：
- CPU: 4 核及以上
- 内存: 8GB 及以上
- 存储: 50GB SSD
- 操作系统: Ubuntu 20.04 LTS / macOS

### 安装步骤

```bash
# 1. 克隆项目
git clone https://github.com/Qiniu-ERE/Sunflower.git
cd Sunflower/lecture-video-composer

# 2. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 文件设置必要参数

# 5. 启动服务
python run_web.py
```

### 配置说明

编辑 `.env` 文件：

```bash
# 服务配置
FLASK_ENV=production
HOST=0.0.0.0
PORT=5000

# 数据目录
DATA_DIR=./data
UPLOAD_DIR=./data/uploads
PROJECT_DIR=./data/projects
EXPORT_DIR=./data/exports

# 文件大小限制（MB）
MAX_AUDIO_SIZE=500
MAX_PHOTO_SIZE=10

# 安全配置
SECRET_KEY=your-secret-key-here
SESSION_TIMEOUT=3600
```

---

## ☁️ 云服务器部署

### 1. 服务器准备

**推荐云服务商**：
- 阿里云 ECS
- 腾讯云 CVM
- AWS EC2
- Azure VM

**服务器规格**：
```
实例类型: 计算型 C5.xlarge（或同等配置）
CPU: 4 核
内存: 8GB
系统盘: 40GB SSD
数据盘: 100GB SSD（可选）
带宽: 5Mbps+
操作系统: Ubuntu 20.04 LTS
```

### 2. 环境配置

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install -y python3 python3-pip python3-venv
sudo apt install -y git nginx supervisor
sudo apt install -y ffmpeg  # 视频处理

# 安装 Python 依赖
pip3 install --upgrade pip setuptools wheel

# 对于 openEuler 系统
# sudo dnf update -y
# sudo dnf install -y python3 python3-pip python3-devel git nginx supervisor
# sudo dnf install -y ffmpeg
```

### 3. 项目部署

```bash
# 创建部署目录
sudo mkdir -p /var/www/lecture-video-composer
sudo chown $USER:$USER /var/www/lecture-video-composer

# 克隆项目
cd /var/www
git clone https://github.com/Qiniu-ERE/Sunflower.git
cd Sunflower/lecture-video-composer

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境
cp .env.example .env
nano .env  # 编辑配置
```

### 4. Nginx 配置

创建 Nginx 配置文件：

```bash
sudo nano /etc/nginx/sites-available/lecture-video-composer
```

配置内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 修改为你的域名

    # 最大上传大小
    client_max_body_size 500M;

    # 静态文件
    location /static {
        alias /var/www/Sunflower/lecture-video-composer/src/web/static;
        expires 30d;
    }

    # 上传文件（需认证访问）
    location /uploads {
        alias /var/www/Sunflower/lecture-video-composer/data/uploads;
        internal;
    }

    # 代理到 Flask 应用
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/lecture-video-composer \
           /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 5. Supervisor 配置

创建 Supervisor 配置：

```bash
sudo nano /etc/supervisor/conf.d/lecture-video-composer.conf
```

配置内容：

```ini
[program:lecture-video-composer]
command=/var/www/Sunflower/lecture-video-composer/venv/bin/python run_web.py
directory=/var/www/Sunflower/lecture-video-composer
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/lecture-video-composer.log
environment=FLASK_ENV="production"
```

启动服务：

```bash
# 重新加载配置
sudo supervisorctl reread
sudo supervisorctl update

# 启动服务
sudo supervisorctl start lecture-video-composer

# 查看状态
sudo supervisorctl status
```

### 6. HTTPS 配置（推荐）

使用 Let's Encrypt 免费证书：

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

---

## 🐳 Docker 部署

### 1. Dockerfile

创建 `Dockerfile`：

```dockerfile
FROM python:3.9-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    ffmpeg \
    git \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制项目文件
COPY . .

# 创建数据目录
RUN mkdir -p /app/data/uploads /app/data/projects /app/data/exports

# 暴露端口
EXPOSE 5000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s \
  CMD python -c "import requests; requests.get('http://localhost:5000/health')"

# 启动命令
CMD ["python", "run_web.py"]
```

### 2. docker-compose.yml

```yaml
version: '3.8'

services:
  web:
    build: .
    container_name: lecture-video-composer
    ports:
      - "5000:5000"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - FLASK_ENV=production
      - SECRET_KEY=${SECRET_KEY}
    restart: unless-stopped
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./data/uploads:/var/www/uploads
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  data:
  logs:
```

### 3. 构建和运行

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 更新服务
git pull
docker-compose build
docker-compose up -d
```

---

## 🚀 Kubernetes 部署

### 1. 部署配置

创建 `k8s/deployment.yaml`：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lecture-video-composer
  labels:
    app: lecture-video-composer
spec:
  replicas: 3
  selector:
    matchLabels:
      app: lecture-video-composer
  template:
    metadata:
      labels:
        app: lecture-video-composer
    spec:
      containers:
      - name: web
        image: your-registry/lecture-video-composer:latest
        ports:
        - containerPort: 5000
        env:
        - name: FLASK_ENV
          value: "production"
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: secret-key
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        volumeMounts:
        - name: data
          mountPath: /app/data
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: data-pvc
```

### 2. Service 配置

创建 `k8s/service.yaml`：

```yaml
apiVersion: v1
kind: Service
metadata:
  name: lecture-video-composer-service
spec:
  selector:
    app: lecture-video-composer
  ports:
    - protocol: TCP
      port: 80
      targetPort: 5000
  type: LoadBalancer
```

### 3. 存储配置

创建 `k8s/pvc.yaml`：

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 100Gi
  storageClassName: standard
```

### 4. 部署到 K8s

```bash
# 创建命名空间
kubectl create namespace lecture-video-composer

# 应用配置
kubectl apply -f k8s/ -n lecture-video-composer

# 查看状态
kubectl get pods -n lecture-video-composer
kubectl get svc -n lecture-video-composer

# 查看日志
kubectl logs -f <pod-name> -n lecture-video-composer
```

---

## 🔒 安全加固

### 1. 防火墙配置

```bash
# UFW（Ubuntu）
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable

# Firewalld（CentOS）
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 2. 访问控制

在 Nginx 中添加基本认证：

```nginx
location / {
    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/.htpasswd;
    # ... 其他配置
}
```

创建密码文件：

```bash
sudo apt install apache2-utils
sudo htpasswd -c /etc/nginx/.htpasswd admin
```

### 3. 限流配置

```nginx
# 在 http 块中添加
limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;

# 在 location 块中应用
location /api/ {
    limit_req zone=mylimit burst=20;
    # ... 其他配置
}
```

---

## 📊 监控与维护

### 1. 日志管理

```bash
# 查看应用日志
tail -f /var/log/lecture-video-composer.log

# 查看 Nginx 日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 日志轮转配置
sudo nano /etc/logrotate.d/lecture-video-composer
```

### 2. 性能监控

安装监控工具：

```bash
# 安装 htop
sudo apt install htop

# 安装 Prometheus + Grafana（可选）
# 详见官方文档
```

### 3. 备份策略

```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR=/backup
DATE=$(date +%Y%m%d_%H%M%S)

# 备份数据目录
tar -czf $BACKUP_DIR/data_$DATE.tar.gz /var/www/Sunflower/lecture-video-composer/data

# 保留最近 7 天的备份
find $BACKUP_DIR -name "data_*.tar.gz" -mtime +7 -delete
EOF

chmod +x backup.sh

# 添加到 crontab（每天凌晨 2 点备份）
0 2 * * * /path/to/backup.sh
```

---

## 🔧 故障排查

### 常见问题

**1. 服务无法启动**
```bash
# 检查端口占用
sudo lsof -i :5000

# 检查日志
journalctl -u lecture-video-composer
