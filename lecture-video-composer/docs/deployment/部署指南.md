# éƒ¨ç½²æŒ‡å—

> ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„å®Œæ•´æŒ‡å—

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•å°†æ¼”è®²è§†é¢‘åˆæˆç³»ç»Ÿéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ŒåŒ…æ‹¬æœ¬åœ°æœåŠ¡å™¨ã€äº‘æœåŠ¡å™¨å’Œå®¹å™¨åŒ–éƒ¨ç½²ã€‚

### éƒ¨ç½²æ–¹å¼

- ğŸ–¥ï¸ **æœ¬åœ°éƒ¨ç½²** - é€‚åˆä¸ªäººæˆ–å°å›¢é˜Ÿä½¿ç”¨
- â˜ï¸ **äº‘æœåŠ¡å™¨éƒ¨ç½²** - é€‚åˆè¿œç¨‹è®¿é—®å’Œå›¢é˜Ÿåä½œ
- ğŸ³ **Docker éƒ¨ç½²** - æ¨èçš„ç”Ÿäº§ç¯å¢ƒæ–¹æ¡ˆ
- ğŸš€ **Kubernetes éƒ¨ç½²** - é€‚åˆå¤§è§„æ¨¡éƒ¨ç½²

---

## ğŸ–¥ï¸ æœ¬åœ°éƒ¨ç½²

### ç³»ç»Ÿè¦æ±‚

**æœ€ä½é…ç½®**ï¼š
- CPU: 2 æ ¸
- å†…å­˜: 4GB
- å­˜å‚¨: 10GB å¯ç”¨ç©ºé—´
- æ“ä½œç³»ç»Ÿ: macOS / Linux / Windows

**æ¨èé…ç½®**ï¼š
- CPU: 4 æ ¸åŠä»¥ä¸Š
- å†…å­˜: 8GB åŠä»¥ä¸Š
- å­˜å‚¨: 50GB SSD
- æ“ä½œç³»ç»Ÿ: Ubuntu 20.04 LTS / macOS

### å®‰è£…æ­¥éª¤

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/Qiniu-ERE/Sunflower.git
cd Sunflower/lecture-video-composer

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 4. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½®å¿…è¦å‚æ•°

# 5. å¯åŠ¨æœåŠ¡
python run_web.py
```

### é…ç½®è¯´æ˜

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
# æœåŠ¡é…ç½®
FLASK_ENV=production
HOST=0.0.0.0
PORT=5000

# æ•°æ®ç›®å½•
DATA_DIR=./data
UPLOAD_DIR=./data/uploads
PROJECT_DIR=./data/projects
EXPORT_DIR=./data/exports

# æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆMBï¼‰
MAX_AUDIO_SIZE=500
MAX_PHOTO_SIZE=10

# å®‰å…¨é…ç½®
SECRET_KEY=your-secret-key-here
SESSION_TIMEOUT=3600
```

---

## â˜ï¸ äº‘æœåŠ¡å™¨éƒ¨ç½²

### 1. æœåŠ¡å™¨å‡†å¤‡

**æ¨èäº‘æœåŠ¡å•†**ï¼š
- é˜¿é‡Œäº‘ ECS
- è…¾è®¯äº‘ CVM
- AWS EC2
- Azure VM

**æœåŠ¡å™¨è§„æ ¼**ï¼š
```
å®ä¾‹ç±»å‹: è®¡ç®—å‹ C5.xlargeï¼ˆæˆ–åŒç­‰é…ç½®ï¼‰
CPU: 4 æ ¸
å†…å­˜: 8GB
ç³»ç»Ÿç›˜: 40GB SSD
æ•°æ®ç›˜: 100GB SSDï¼ˆå¯é€‰ï¼‰
å¸¦å®½: 5Mbps+
æ“ä½œç³»ç»Ÿ: Ubuntu 20.04 LTS
```

### 2. ç¯å¢ƒé…ç½®

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…å¿…è¦è½¯ä»¶
sudo apt install -y python3 python3-pip python3-venv
sudo apt install -y git nginx supervisor
sudo apt install -y ffmpeg  # è§†é¢‘å¤„ç†

# å®‰è£… Python ä¾èµ–
pip3 install --upgrade pip setuptools wheel

# å¯¹äº openEuler ç³»ç»Ÿ
# sudo dnf update -y
# sudo dnf install -y python3 python3-pip python3-devel git nginx supervisor
# sudo dnf install -y ffmpeg
```

### 3. é¡¹ç›®éƒ¨ç½²

```bash
# åˆ›å»ºéƒ¨ç½²ç›®å½•
sudo mkdir -p /var/www/lecture-video-composer
sudo chown $USER:$USER /var/www/lecture-video-composer

# å…‹éš†é¡¹ç›®
cd /var/www
git clone https://github.com/Qiniu-ERE/Sunflower.git
cd Sunflower/lecture-video-composer

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒ
cp .env.example .env
nano .env  # ç¼–è¾‘é…ç½®
```

### 4. Nginx é…ç½®

åˆ›å»º Nginx é…ç½®æ–‡ä»¶ï¼š

```bash
sudo nano /etc/nginx/sites-available/lecture-video-composer
```

é…ç½®å†…å®¹ï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;  # ä¿®æ”¹ä¸ºä½ çš„åŸŸå

    # æœ€å¤§ä¸Šä¼ å¤§å°
    client_max_body_size 500M;

    # é™æ€æ–‡ä»¶
    location /static {
        alias /var/www/Sunflower/lecture-video-composer/src/web/static;
        expires 30d;
    }

    # ä¸Šä¼ æ–‡ä»¶ï¼ˆéœ€è®¤è¯è®¿é—®ï¼‰
    location /uploads {
        alias /var/www/Sunflower/lecture-video-composer/data/uploads;
        internal;
    }

    # ä»£ç†åˆ° Flask åº”ç”¨
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket æ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼‰
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
```

å¯ç”¨é…ç½®ï¼š

```bash
sudo ln -s /etc/nginx/sites-available/lecture-video-composer \
           /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

### 5. Supervisor é…ç½®

åˆ›å»º Supervisor é…ç½®ï¼š

```bash
sudo nano /etc/supervisor/conf.d/lecture-video-composer.conf
```

é…ç½®å†…å®¹ï¼š

```ini
[program:lecture-video-composer]
command=/var/www/Sunflower/lecture-video-composer/venv/bin/python run_web.py
directory=/var/www/Sunflower/lecture-video-composer
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/lecture-video-composer.log
environment=FLASK_ENV="production"
```

å¯åŠ¨æœåŠ¡ï¼š

```bash
# é‡æ–°åŠ è½½é…ç½®
sudo supervisorctl reread
sudo supervisorctl update

# å¯åŠ¨æœåŠ¡
sudo supervisorctl start lecture-video-composer

# æŸ¥çœ‹çŠ¶æ€
sudo supervisorctl status
```

### 6. HTTPS é…ç½®ï¼ˆæ¨èï¼‰

ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦ï¼š

```bash
# å®‰è£… Certbot
sudo apt install -y certbot python3-certbot-nginx

# ç”³è¯·è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

## ğŸ³ Docker éƒ¨ç½²

### 1. Dockerfile

åˆ›å»º `Dockerfile`ï¼š

```dockerfile
FROM python:3.9-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    ffmpeg \
    git \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY . .

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p /app/data/uploads /app/data/projects /app/data/exports

# æš´éœ²ç«¯å£
EXPOSE 5000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s \
  CMD python -c "import requests; requests.get('http://localhost:5000/health')"

# å¯åŠ¨å‘½ä»¤
CMD ["python", "run_web.py"]
```

### 2. docker-compose.yml

```yaml
version: '3.8'

services:
  web:
    build: .
    container_name: lecture-video-composer
    ports:
      - "5000:5000"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - FLASK_ENV=production
      - SECRET_KEY=${SECRET_KEY}
    restart: unless-stopped
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./data/uploads:/var/www/uploads
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  data:
  logs:
```

### 3. æ„å»ºå’Œè¿è¡Œ

```bash
# æ„å»ºé•œåƒ
docker-compose build

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down

# æ›´æ–°æœåŠ¡
git pull
docker-compose build
docker-compose up -d
```

---

## ğŸš€ Kubernetes éƒ¨ç½²

### 1. éƒ¨ç½²é…ç½®

åˆ›å»º `k8s/deployment.yaml`ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lecture-video-composer
  labels:
    app: lecture-video-composer
spec:
  replicas: 3
  selector:
    matchLabels:
      app: lecture-video-composer
  template:
    metadata:
      labels:
        app: lecture-video-composer
    spec:
      containers:
      - name: web
        image: your-registry/lecture-video-composer:latest
        ports:
        - containerPort: 5000
        env:
        - name: FLASK_ENV
          value: "production"
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: secret-key
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        volumeMounts:
        - name: data
          mountPath: /app/data
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: data-pvc
```

### 2. Service é…ç½®

åˆ›å»º `k8s/service.yaml`ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: lecture-video-composer-service
spec:
  selector:
    app: lecture-video-composer
  ports:
    - protocol: TCP
      port: 80
      targetPort: 5000
  type: LoadBalancer
```

### 3. å­˜å‚¨é…ç½®

åˆ›å»º `k8s/pvc.yaml`ï¼š

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 100Gi
  storageClassName: standard
```

### 4. éƒ¨ç½²åˆ° K8s

```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace lecture-video-composer

# åº”ç”¨é…ç½®
kubectl apply -f k8s/ -n lecture-video-composer

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n lecture-video-composer
kubectl get svc -n lecture-video-composer

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f <pod-name> -n lecture-video-composer
```

---

## ğŸ”’ å®‰å…¨åŠ å›º

### 1. é˜²ç«å¢™é…ç½®

```bash
# UFWï¼ˆUbuntuï¼‰
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable

# Firewalldï¼ˆCentOSï¼‰
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 2. è®¿é—®æ§åˆ¶

åœ¨ Nginx ä¸­æ·»åŠ åŸºæœ¬è®¤è¯ï¼š

```nginx
location / {
    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/.htpasswd;
    # ... å…¶ä»–é…ç½®
}
```

åˆ›å»ºå¯†ç æ–‡ä»¶ï¼š

```bash
sudo apt install apache2-utils
sudo htpasswd -c /etc/nginx/.htpasswd admin
```

### 3. é™æµé…ç½®

```nginx
# åœ¨ http å—ä¸­æ·»åŠ 
limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;

# åœ¨ location å—ä¸­åº”ç”¨
location /api/ {
    limit_req zone=mylimit burst=20;
    # ... å…¶ä»–é…ç½®
}
```

---

## ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤

### 1. æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /var/log/lecture-video-composer.log

# æŸ¥çœ‹ Nginx æ—¥å¿—
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# æ—¥å¿—è½®è½¬é…ç½®
sudo nano /etc/logrotate.d/lecture-video-composer
```

### 2. æ€§èƒ½ç›‘æ§

å®‰è£…ç›‘æ§å·¥å…·ï¼š

```bash
# å®‰è£… htop
sudo apt install htop

# å®‰è£… Prometheus + Grafanaï¼ˆå¯é€‰ï¼‰
# è¯¦è§å®˜æ–¹æ–‡æ¡£
```

### 3. å¤‡ä»½ç­–ç•¥

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR=/backup
DATE=$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½æ•°æ®ç›®å½•
tar -czf $BACKUP_DIR/data_$DATE.tar.gz /var/www/Sunflower/lecture-video-composer/data

# ä¿ç•™æœ€è¿‘ 7 å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "data_*.tar.gz" -mtime +7 -delete
EOF

chmod +x backup.sh

# æ·»åŠ åˆ° crontabï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½ï¼‰
0 2 * * * /path/to/backup.sh
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. æœåŠ¡æ— æ³•å¯åŠ¨**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo lsof -i :5000

# æ£€æŸ¥æ—¥å¿—
journalctl -u lecture-video-composer
